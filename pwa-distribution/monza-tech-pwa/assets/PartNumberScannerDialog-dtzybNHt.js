import{R as Y,aP as A,s as O,r as a,ao as Q,$ as X,j as e,D as G,aQ as J,a as m,q as K,v as Z,w as D,ab as E,au as F,X as ee,L as re,I as te}from"./index-CnqA2hW7.js";import{L as V}from"./loader-2-V0qBl2-O.js";import{R as B}from"./rotate-ccw-BuCGxA2w.js";/**
 * @license lucide-react v0.309.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const R=Y("ScanLine",[["path",{d:"M3 7V5a2 2 0 0 1 2-2h2",key:"aa7l1z"}],["path",{d:"M17 3h2a2 2 0 0 1 2 2v2",key:"4qcy5o"}],["path",{d:"M21 17v2a2 2 0 0 1-2 2h-2",key:"6vwrx8"}],["path",{d:"M7 21H5a2 2 0 0 1-2-2v-2",key:"ioqczr"}],["path",{d:"M7 12h10",key:"b7w52i"}]]),ae=async N=>{try{return(await A.processEnhancedMessage("Extract and return ONLY the part number from this image. Look for alphanumeric codes that could be part numbers. Return only the part number, nothing else.",{source:"part_number_extraction",imageData:N,currentRoute:"/scan-part"})).textResponse.trim().replace(/[^\w-]/g,"").substring(0,50)}catch(r){throw console.error("Part number OCR extraction error:",r),new Error("Failed to extract part number from image")}};class se{async trackEvent(r){try{const{error:n}=await O.from("user_activity_logs").insert({activity_type:r.eventType,user_name:r.userName,description:`${r.entityType}: ${r.entityId}`,user_id:r.userName||"unknown"});n&&console.error("Error tracking workflow event:",n)}catch(n){console.error("Error in workflow tracking:",n)}}async trackVinScan(r){await this.trackEvent({eventType:"vin_scan",entityType:"vehicle",entityId:r.vinNumber,userName:r.scannedBy,metadata:{scanMethod:r.scanMethod,destination:r.carDestination}})}async trackPartScan(r){await this.trackEvent({eventType:"part_scan",entityType:"part",entityId:r.partNumber,userName:r.scannedBy,metadata:{scanMethod:r.scanMethod,photoUrl:r.photoUrl,ocrConfidence:r.ocrConfidence}})}async trackPartUsage(r){await this.trackEvent({eventType:"part_usage",entityType:"part",entityId:r.partNumber,userName:r.usedBy||r.technician||"Unknown",metadata:{partName:r.partName,quantity:r.quantity,carVin:r.carVin,carModel:r.carModel,clientName:r.clientName,clientPhone:r.clientPhone,clientLicensePlate:r.clientLicensePlate,repairId:r.repairId,costPerUnit:r.costPerUnit,totalCost:r.totalCost}})}async trackClientInteraction(r){await this.trackEvent({eventType:"client_interaction",entityType:"client",entityId:r.clientName,userName:r.handledBy||r.employee||"Unknown",metadata:{clientPhone:r.clientPhone,clientLicensePlate:r.clientLicensePlate,carVin:r.carVin,interactionType:r.interactionType,details:r.details||r.notes}})}async trackWorkflowEvent(r){await this.trackEvent({eventType:r.eventType,entityType:r.entityType,entityId:r.entityId,userName:r.userName,metadata:{details:r.details,...r.metadata}})}async trackPhoto(r,n,c,u,h,p){await this.trackEvent({eventType:"photo_capture",entityType:c,entityId:h,userName:u,metadata:{photoUrl:r,context:n,...p}})}async getWorkflowHistory(r,n){try{let c=O.from("user_activity_logs").select("*").order("created_at",{ascending:!1});r&&(c=c.ilike("description",`${r}%`));const{data:u,error:h}=await c;return h?(console.error("Error fetching workflow history:",h),[]):u||[]}catch(c){return console.error("Error in getWorkflowHistory:",c),[]}}}const T=new se,oe=({onPartNumberScanned:N,children:r})=>{const[n,c]=a.useState(!1),[u,h]=a.useState(!1),[p,k]=a.useState(!1),[i,v]=a.useState(null),[x,g]=a.useState(""),[j,I]=a.useState(""),[P,y]=a.useState(!1),[M,b]=a.useState(null),s=a.useRef(null),C=a.useRef(null),f=a.useRef(null),{toast:l}=Q(),{user:d}=X(),U=async()=>{try{console.log("Starting part number scanner camera..."),b(null);const t=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment",width:{ideal:1280},height:{ideal:720}}});f.current=t,s.current&&(s.current.srcObject=t,s.current.onloadedmetadata=()=>{console.log("Video metadata loaded"),s.current&&s.current.play().then(()=>{console.log("Video playing"),h(!0),v(null),g(""),y(!1),l({title:"Camera ready",description:"Position the part number clearly in the target area and capture"})}).catch(o=>{console.error("Error playing video:",o),b("Failed to play video stream")})},s.current.onerror=o=>{console.error("Video element error:",o),b("Video element error")})}catch(t){console.error("Error accessing camera:",t),b(t instanceof Error?t.message:"Unknown camera error"),l({title:"Camera error",description:"Could not access camera. Please check permissions.",variant:"destructive"})}},w=()=>{f.current&&(f.current.getTracks().forEach(t=>t.stop()),f.current=null),s.current&&(s.current.srcObject=null),h(!1),b(null)},q=()=>{if(!(!s.current||!C.current||!f.current))try{const t=s.current,o=C.current,L=o.getContext("2d");if(!L)return;o.width=t.videoWidth,o.height=t.videoHeight,L.drawImage(t,0,0,o.width,o.height);const z=o.toDataURL("image/jpeg",.9);v(z),w(),l({title:"Image captured",description:"Image captured successfully. Click 'Process with OCR' to extract part number."})}catch(t){console.error("Image capture error:",t),l({title:"Capture failed",description:"Failed to capture image. Please try again.",variant:"destructive"})}},W=async()=>{if(i){k(!0);try{const t=await ae(i);t&&t.trim()?(g(t),await T.trackPartScan({partNumber:t,scanMethod:"camera",scannedBy:(d==null?void 0:d.name)||"Unknown User",photoUrl:i,ocrConfidence:.8}),await T.trackPhoto(i,"part_scan",t,(d==null?void 0:d.name)||"Unknown User",t,{ocrProcessed:!0}),l({title:"Part number detected",description:`Extracted: ${t}`})):(g(""),y(!0),l({title:"No part number detected",description:"Please enter the part number manually or try again.",variant:"destructive"}))}catch(t){console.error("OCR processing error:",t),g(""),y(!0),l({title:"OCR failed",description:"Failed to process image. Please enter part number manually.",variant:"destructive"})}finally{k(!1)}}},$=async()=>{const t=x||j;t.trim()?(j&&!x&&await T.trackPartScan({partNumber:t.trim(),scanMethod:"manual",scannedBy:(d==null?void 0:d.name)||"Unknown User"}),N(t.trim()),c(!1),S(),l({title:"Part number confirmed",description:`Part number ${t} has been added`})):l({title:"No part number",description:"Please enter a part number or scan again.",variant:"destructive"})},S=()=>{w(),v(null),g(""),I(""),y(!1),k(!1),b(null)},_=()=>{v(null),g(""),y(!1),U()},H=t=>{c(t),t||S()};return a.useEffect(()=>()=>{w()},[]),e.jsxs(G,{open:n,onOpenChange:H,children:[e.jsx(J,{asChild:!0,children:r||e.jsx(m,{variant:"outline",size:"sm",children:e.jsx(R,{className:"h-4 w-4"})})}),e.jsxs(K,{className:"max-w-2xl max-h-[90vh] overflow-y-auto",children:[e.jsx(Z,{children:e.jsxs(D,{className:"flex items-center gap-2",children:[e.jsx(R,{className:"h-5 w-5"}),"Scan Part Number"]})}),e.jsxs("div",{className:"space-y-4",children:[M&&e.jsx("div",{className:"p-3 bg-red-50 border border-red-200 rounded-lg",children:e.jsxs("p",{className:"text-sm text-red-600",children:["Camera Error: ",M]})}),e.jsxs("div",{className:"w-full aspect-video bg-slate-100 rounded-md overflow-hidden relative",children:[u&&!i?e.jsxs(e.Fragment,{children:[e.jsx("video",{ref:s,className:"w-full h-full object-cover",playsInline:!0,muted:!0,autoPlay:!0}),e.jsxs("div",{className:"absolute inset-0 pointer-events-none",children:[e.jsx("div",{className:"absolute inset-0 bg-black bg-opacity-40"}),e.jsx("div",{className:"absolute inset-0 flex items-center justify-center",children:e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"w-64 h-16 border-2 border-white border-dashed bg-transparent rounded-lg"}),e.jsx("div",{className:"absolute -top-2 -left-2 w-6 h-6 border-l-4 border-t-4 border-green-400 rounded-tl-lg"}),e.jsx("div",{className:"absolute -top-2 -right-2 w-6 h-6 border-r-4 border-t-4 border-green-400 rounded-tr-lg"}),e.jsx("div",{className:"absolute -bottom-2 -left-2 w-6 h-6 border-l-4 border-b-4 border-green-400 rounded-bl-lg"}),e.jsx("div",{className:"absolute -bottom-2 -right-2 w-6 h-6 border-r-4 border-b-4 border-green-400 rounded-br-lg"})]})}),e.jsx("div",{className:"absolute bottom-4 left-0 right-0 text-center",children:e.jsx("p",{className:"text-white text-sm font-medium bg-black bg-opacity-60 rounded-full px-4 py-2 mx-4",children:"Position part number in the target area"})}),e.jsxs("div",{className:"absolute top-2 left-2 bg-red-500 text-white px-2 py-1 rounded text-xs flex items-center gap-1",children:[e.jsx("div",{className:"w-2 h-2 bg-white rounded-full animate-pulse"}),"LIVE"]})]})]}):i?e.jsxs("div",{className:"relative w-full h-full",children:[e.jsx("img",{src:i,alt:"Captured part",className:"w-full h-full object-cover rounded-md"}),p&&e.jsx("div",{className:"absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center",children:e.jsxs("div",{className:"bg-white rounded-lg p-4 flex items-center gap-3",children:[e.jsx(V,{className:"h-5 w-5 animate-spin"}),e.jsx("span",{className:"text-sm font-medium",children:"Processing with OCR..."})]})})]}):e.jsxs("div",{className:"flex flex-col items-center justify-center h-full text-muted-foreground",children:[e.jsx(E,{className:"h-16 w-16 mb-2 opacity-30"}),e.jsx("p",{className:"text-sm",children:'Click "Start Camera" to begin scanning'}),e.jsx("p",{className:"text-xs mt-1",children:"Position part number clearly for best results"})]}),e.jsx("canvas",{ref:C,className:"hidden"})]}),x&&e.jsxs("div",{className:"bg-green-50 border border-green-200 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(F,{className:"h-4 w-4 text-green-600"}),e.jsx("span",{className:"text-sm font-medium text-green-700",children:"Part Number Detected"})]}),e.jsx("div",{className:"bg-white rounded px-3 py-2 border",children:e.jsx("span",{className:"font-mono font-semibold text-lg",children:x})})]}),P&&e.jsxs("div",{className:"bg-amber-50 border border-amber-200 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[e.jsx(ee,{className:"h-4 w-4 text-amber-600"}),e.jsx("span",{className:"text-sm font-medium text-amber-700",children:"Manual Entry Required"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(re,{htmlFor:"manualPartNumber",className:"text-sm",children:"Enter Part Number:"}),e.jsx(te,{id:"manualPartNumber",value:j,onChange:t=>I(t.target.value),placeholder:"Enter part number manually...",className:"font-mono"})]})]}),e.jsxs("div",{className:"flex gap-2",children:[!u&&!i&&e.jsxs(m,{onClick:U,className:"flex-1",disabled:p,children:[e.jsx(E,{className:"mr-2 h-4 w-4"}),"Start Camera"]}),u&&!i&&e.jsxs(e.Fragment,{children:[e.jsx(m,{onClick:w,variant:"outline",className:"flex-1",children:"Cancel"}),e.jsxs(m,{onClick:q,className:"flex-1",disabled:!f.current,children:[e.jsx(E,{className:"mr-2 h-4 w-4"}),"Capture Image"]})]}),i&&!x&&!P&&e.jsxs(e.Fragment,{children:[e.jsxs(m,{onClick:_,variant:"outline",className:"flex-1",disabled:p,children:[e.jsx(B,{className:"mr-2 h-4 w-4"}),"Retake"]}),e.jsx(m,{onClick:W,disabled:p,className:"flex-1",children:p?e.jsxs(e.Fragment,{children:[e.jsx(V,{className:"mr-2 h-4 w-4 animate-spin"}),"Processing..."]}):e.jsxs(e.Fragment,{children:[e.jsx(R,{className:"mr-2 h-4 w-4"}),"Process with OCR"]})})]}),(x||P&&j)&&e.jsxs(e.Fragment,{children:[e.jsxs(m,{onClick:_,variant:"outline",className:"flex-1",children:[e.jsx(B,{className:"mr-2 h-4 w-4"}),"Retake Photo"]}),e.jsxs(m,{onClick:$,className:"flex-1",children:[e.jsx(F,{className:"mr-2 h-4 w-4"}),"Use Part Number"]})]})]}),e.jsxs("div",{className:"text-xs text-muted-foreground text-center space-y-1",children:[e.jsx("p",{children:"• Position the part number clearly within the target area"}),e.jsx("p",{children:"• Ensure good lighting and focus for best OCR results"}),e.jsx("p",{children:"• You can manually enter the part number if OCR fails"})]})]})]})]})};export{oe as P,R as S,ae as e,T as w};
