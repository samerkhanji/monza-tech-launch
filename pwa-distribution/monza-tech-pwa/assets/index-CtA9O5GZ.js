import{aH as re,r as n,$ as ie,bM as le,t as c,j as e,a as d,aO as ne,b as S,c as I,d as E,bY as ce,B as oe,f as V,ak as R,ab as k,e as A,L as g,I as _,a3 as q,D as de,q as me,v as xe,w as he,U as Z,ad as P,aa as ue,C as Ne,bW as ve}from"./index-BKWZsjPE.js";import{enhancedRepairHistoryService as pe}from"./enhancedRepairHistoryService-CSUGLcPB.js";import{L as ge}from"./loader-2-D5fSlfQJ.js";import{S as B}from"./stop-circle-CbUFZd9a.js";const Te=()=>{const W=re(),[j,$]=n.useState(!1),[x,b]=n.useState(null),[h,y]=n.useState([]),[Y,f]=n.useState(!1),[l,H]=n.useState(null),[a,u]=n.useState({isClientTestDrive:!0,driverName:"",clientName:"",testDriveNotes:""}),[T,L]=n.useState(""),N=n.useRef(null),w=n.useRef(null),{user:z}=ie(),{granted:F,stream:C,requestCamera:G,hasActiveStream:p}=le();n.useEffect(()=>{const t=localStorage.getItem("activeTestDrives");if(t){const s=JSON.parse(t);y(s.map(r=>({...r,startTime:new Date(r.startTime)})))}},[]),n.useEffect(()=>{localStorage.setItem("activeTestDrives",JSON.stringify(h))},[h]),n.useEffect(()=>{F&&!p&&O()},[F,p]),n.useEffect(()=>{N.current&&C&&(N.current.srcObject=C,N.current.play().catch(console.error))},[C]);const O=async()=>{try{await G({video:{facingMode:"environment",width:{ideal:1280},height:{ideal:720}}}),c({title:"ðŸ“· Camera Ready",description:"Point camera at VIN for INSTANT test drive start!"})}catch(t){console.error("Camera access error:",t),c({title:"Camera Error",description:"Could not access camera. Use manual VIN entry instead.",variant:"destructive"})}},K=()=>{if(!N.current||!w.current){c({title:"Camera not ready",description:"Please ensure the camera is active before capturing.",variant:"destructive"});return}const t=N.current,s=w.current,r=s.getContext("2d");if(!r){c({title:"Canvas error",description:"Unable to capture photo. Please try again.",variant:"destructive"});return}s.width=t.videoWidth,s.height=t.videoHeight,r.drawImage(t,0,0,s.width,s.height);const i=s.toDataURL("image/jpeg",.9);b(i),c({title:"ðŸ“¸ VIN Captured",description:"Click 'START INSTANT TEST DRIVE' to begin immediately!"})},Q=t=>{const s=[/\b[A-HJ-NPR-Z0-9]{17}\b/gi,/(?:VIN|V\.I\.N|VEHICLE\s+ID|CHASSIS)[:#\s]*([A-HJ-NPR-Z0-9]{17})/gi];for(const r of s){const i=t.match(r);if(i)for(const m of i){const o=m.replace(/[^A-HJ-NPR-Z0-9]/gi,"").toUpperCase();if(o.length===17&&/^[A-HJ-NPR-Z0-9]{17}$/i.test(o))return o}}return null},X=async()=>{if(!x){c({title:"No VIN captured",description:"Please capture a VIN photo first.",variant:"destructive"});return}$(!0);try{const t=await ve(x);if(t&&t.length>=5){const s=Q(t);s?await M(s):c({title:"No VIN Found",description:"Could not detect a valid VIN. Try manual entry below.",variant:"destructive"})}else c({title:"No Text Found",description:"Could not extract text from image. Ensure VIN is clearly visible.",variant:"destructive"})}catch(t){console.error("OCR extraction error:",t),c({title:"OCR Error",description:"Failed to process image. Try manual VIN entry instead.",variant:"destructive"})}finally{$(!1)}},M=async t=>{var J;const s=h.find(D=>D.vin===t);if(s){c({title:"Car Already on Test Drive",description:`This vehicle is currently being test driven by ${s.employeeScanned}`,variant:"destructive"});return}const r={model:"Voyah Free",year:2024,brand:"Voyah"},i=z||{email:"Unknown User",user_metadata:{full_name:"Unknown Employee"}},m=((J=i==null?void 0:i.user_metadata)==null?void 0:J.full_name)||i.email||"Unknown Employee",o=i.email||"unknown@monzasal.com",v={id:`td-${Date.now()}`,vin:t,carModel:`${r.year} ${r.brand} ${r.model}`,startTime:new Date,employeeScanned:m,employeeEmail:o};y(D=>[...D,v]),b(null),L("")},ee=async()=>{if(!T.trim()){c({title:"VIN Required",description:"Please enter a VIN number",variant:"destructive"});return}const t=T.trim().toUpperCase();if(!/^[A-HJ-NPR-Z0-9]{17}$/i.test(t)){c({title:"Invalid VIN",description:"VIN must be 17 characters long and contain only letters and numbers",variant:"destructive"});return}await M(t)},te=t=>{H(t),u({isClientTestDrive:!0,driverName:t.employeeScanned,clientName:"",testDriveNotes:""}),f(!0)},se=async()=>{var m;if(!l)return;if(!a.driverName.trim()){c({title:"Driver Name Required",description:"Please enter who drove the vehicle",variant:"destructive"});return}if(a.isClientTestDrive&&!((m=a.clientName)!=null&&m.trim())){c({title:"Client Name Required",description:"Please enter the client's name for client test drives",variant:"destructive"});return}const t=new Date,s=Math.round((t.getTime()-l.startTime.getTime())/1e3/60);y(o=>o.filter(v=>v.id!==l.id)),f(!1),H(null);const r={...l,endTime:t,duration:s,driverName:a.driverName,clientName:a.clientName,isClientTestDrive:a.isClientTestDrive,testDriveNotes:a.testDriveNotes,completedAt:new Date().toISOString()},i=JSON.parse(localStorage.getItem("testDriveHistory")||"[]");i.push(r),localStorage.setItem("testDriveHistory",JSON.stringify(i));try{const o={car_vin:l.vin,car_model:l.carModel,client_name:a.clientName||a.driverName,client_phone:"",client_email:"",issue_description:`${a.isClientTestDrive?"Client":"Employee"} Test Drive - Scanned by: ${l.employeeScanned}. ${a.testDriveNotes||"Standard test drive evaluation"}`,solution_description:`Test drive completed successfully. Duration: ${s} minutes. Scanned by: ${l.employeeScanned}, Driver: ${a.driverName}${a.clientName?`, Client: ${a.clientName}`:""}. ${a.testDriveNotes?`Notes: ${a.testDriveNotes}`:""}`,repair_steps:["Employee scanned VIN and took vehicle instantly","Test drive commenced immediately with timer tracking","Vehicle performance evaluated during drive","Test drive completed and returned safely","Client/driver details collected and recorded"],parts_used:[],labor_hours:s/60,total_cost:0,technician_name:l.employeeScanned,repair_date:l.startTime.toISOString().split("T")[0],completion_date:t.toISOString().split("T")[0],photos:[],before_photos:[],after_photos:[],repair_category:"Test Drive",difficulty_level:"easy",quality_rating:5,client_satisfaction:5,warranty_period:0,follow_up_required:a.isClientTestDrive,follow_up_notes:a.isClientTestDrive?"Follow up with client for sales opportunity":void 0},v=await pe.saveRepairHistory(o);v&&console.log("âœ… Test drive successfully recorded in repair history:",v.id)}catch(o){console.error("âŒ Error saving test drive to repair history:",o),c({title:"Partial Save",description:"Test drive completed but may not be fully recorded in history",variant:"destructive",duration:3e3})}},U=t=>{const r=Math.floor((new Date().getTime()-t.getTime())/1e3),i=Math.floor(r/3600),m=Math.floor(r%3600/60),o=r%60;return i>0?`${i}:${m.toString().padStart(2,"0")}:${o.toString().padStart(2,"0")}`:`${m}:${o.toString().padStart(2,"0")}`},ae=({testDrive:t})=>{const[s,r]=n.useState("");return n.useEffect(()=>{const i=setInterval(()=>{r(U(t.startTime))},1e3);return()=>clearInterval(i)},[t.startTime]),e.jsxs("tr",{className:"border-b border-gray-200 hover:bg-gray-50",children:[e.jsx("td",{className:"px-4 py-3",children:e.jsx("div",{className:"font-mono text-sm",children:t.vin})}),e.jsx("td",{className:"px-4 py-3",children:e.jsx("div",{className:"font-medium",children:t.carModel})}),e.jsx("td",{className:"px-4 py-3",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(P,{className:"h-4 w-4 text-blue-500"}),e.jsx("span",{className:"font-medium",children:t.employeeScanned})]})}),e.jsx("td",{className:"px-4 py-3",children:e.jsx("div",{className:"text-sm text-gray-600",children:t.startTime.toLocaleTimeString()})}),e.jsx("td",{className:"px-4 py-3",children:e.jsx("div",{className:"text-2xl font-mono font-bold text-green-600",children:s})}),e.jsx("td",{className:"px-4 py-3",children:e.jsxs(d,{onClick:()=>te(t),size:"sm",className:"bg-red-600 hover:bg-red-700 text-white",children:[e.jsx(B,{className:"h-4 w-4 mr-1"}),"END TEST DRIVE"]})})]})};return e.jsxs("div",{className:"container mx-auto p-6 space-y-6 max-w-6xl",children:[e.jsxs("div",{className:"flex items-center mb-8",children:[e.jsxs(d,{variant:"outline",size:"sm",className:"mr-4",onClick:()=>W(-1),children:[e.jsx(ne,{className:"mr-1 h-4 w-4"}),"Back"]}),e.jsxs("div",{className:"text-center flex-1",children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-900 mb-2",children:"INSTANT Test Drive Scanner"}),e.jsx("p",{className:"text-gray-600 text-lg",children:"Scan VIN â†’ Car instantly taken for test drive â†’ Fill details when returning"})]})]}),h.length>0&&e.jsxs(S,{className:"border-green-200 bg-green-50 border-2",children:[e.jsx(I,{children:e.jsxs(E,{className:"flex items-center gap-2 text-green-700",children:[e.jsx(ce,{className:"h-6 w-6"}),"ðŸŸ¢ LIVE TEST DRIVES - CURRENTLY ACTIVE (",h.length,")",e.jsxs(oe,{className:"bg-green-500 text-white px-3 py-1 text-sm",children:[h.length," Cars Out"]})]})}),e.jsx(V,{children:e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"border-b-2 border-green-300 bg-green-100",children:[e.jsx("th",{className:"px-4 py-3 text-left font-semibold",children:"VIN"}),e.jsx("th",{className:"px-4 py-3 text-left font-semibold",children:"Vehicle"}),e.jsx("th",{className:"px-4 py-3 text-left font-semibold",children:"Taken By"}),e.jsx("th",{className:"px-4 py-3 text-left font-semibold",children:"Start Time"}),e.jsx("th",{className:"px-4 py-3 text-left font-semibold",children:"Duration (Live)"}),e.jsx("th",{className:"px-4 py-3 text-left font-semibold",children:"Action"})]})}),e.jsx("tbody",{children:h.map(t=>e.jsx(ae,{testDrive:t},t.id))})]})})})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsxs(S,{className:"border-blue-300 bg-blue-50 border-2",children:[e.jsx(I,{children:e.jsxs(E,{className:"flex items-center gap-2 text-blue-700 text-xl",children:[e.jsx(R,{className:"h-6 w-6"}),"INSTANT VIN Scanner"]})}),e.jsxs(V,{className:"space-y-4",children:[e.jsxs("div",{className:"relative",children:[x?e.jsx("img",{src:x,alt:"Captured VIN",className:"w-full h-64 rounded-md object-contain border-2 border-blue-300"}):e.jsxs(e.Fragment,{children:[e.jsx("video",{ref:N,className:"w-full h-64 rounded-md bg-gray-100 object-cover border-2 border-blue-300",autoPlay:!0,playsInline:!0,muted:!0}),e.jsx("canvas",{ref:w,className:"hidden"})]}),!p&&!x&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center bg-gray-100 rounded-md",children:e.jsxs("div",{className:"text-center",children:[e.jsx(k,{className:"mx-auto h-12 w-12 text-gray-400 mb-2"}),e.jsx("p",{className:"text-sm text-gray-500",children:"Camera not active"})]})}),p&&!x&&e.jsx("div",{className:"absolute top-3 left-3",children:e.jsxs("div",{className:"flex items-center gap-2 bg-red-500 text-white px-3 py-2 rounded-full text-sm font-bold",children:[e.jsx("div",{className:"w-2 h-2 bg-white rounded-full animate-pulse"}),"LIVE - READY TO SCAN"]})})]}),e.jsx("div",{className:"flex gap-2",children:p?x?e.jsxs(e.Fragment,{children:[e.jsxs(d,{onClick:X,disabled:j,className:"flex-1 bg-green-600 hover:bg-green-700 text-white text-lg font-bold py-4",children:[j?e.jsx(ge,{className:"h-5 w-5 mr-2 animate-spin"}):e.jsx(R,{className:"h-5 w-5 mr-2"}),j?"STARTING...":e.jsxs(e.Fragment,{children:[e.jsx(A,{className:"w-4 h-4 mr-2"}),"START INSTANT TEST DRIVE"]})]}),e.jsx(d,{onClick:()=>b(null),variant:"outline",className:"text-sm",children:"Retake"})]}):e.jsxs(d,{onClick:K,className:"flex-1 bg-blue-600 hover:bg-blue-700 text-lg font-bold py-3",children:[e.jsx(k,{className:"h-5 w-5 mr-2"}),"ðŸ“¸ CAPTURE VIN"]}):e.jsxs(d,{onClick:O,className:"flex-1 bg-blue-600 hover:bg-blue-700",children:[e.jsx(k,{className:"h-4 w-4 mr-2"}),"Start Camera"]})}),e.jsxs("div",{className:"space-y-3 border-t-2 border-blue-200 pt-4",children:[e.jsx(g,{htmlFor:"manualVin",className:"text-base font-semibold",children:"âŒ¨ï¸ Or Enter VIN Manually"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(_,{id:"manualVin",value:T,onChange:t=>L(t.target.value.toUpperCase()),placeholder:"Enter 17-character VIN",maxLength:17,className:"flex-1 h-12 text-base"}),e.jsxs(d,{onClick:ee,className:"bg-green-600 hover:bg-green-700 text-white font-bold px-6",children:[e.jsx(R,{className:"h-4 w-4 mr-2"}),"START!"]})]})]})]})]}),e.jsxs(S,{className:"border-yellow-300 bg-yellow-50 border-2",children:[e.jsx(I,{children:e.jsxs(E,{className:"flex items-center gap-2 text-yellow-700 text-xl",children:[e.jsx(q,{className:"h-6 w-6"}),"How Instant Test Drive Works"]})}),e.jsxs(V,{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-start gap-3 p-3 bg-white rounded-lg border border-yellow-200",children:[e.jsx("div",{className:"w-8 h-8 bg-blue-500 text-white rounded-full flex items-center justify-center text-sm font-bold",children:"1"}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold text-blue-700",children:"Scan or Enter VIN"}),e.jsx("p",{className:"text-sm text-gray-600",children:"Point camera at VIN or type it manually"})]})]}),e.jsxs("div",{className:"flex items-start gap-3 p-3 bg-white rounded-lg border border-yellow-200",children:[e.jsx("div",{className:"w-8 h-8 bg-green-500 text-white rounded-full flex items-center justify-center text-sm font-bold",children:"2"}),e.jsxs("div",{children:[e.jsxs("h4",{className:"font-semibold text-green-700 flex items-center gap-2",children:[e.jsx(A,{className:"w-4 h-4"}),"INSTANT START!"]}),e.jsx("p",{className:"text-sm text-gray-600",children:"Test drive timer starts immediately - take the car and go!"})]})]}),e.jsxs("div",{className:"flex items-start gap-3 p-3 bg-white rounded-lg border border-yellow-200",children:[e.jsx("div",{className:"w-8 h-8 bg-orange-500 text-white rounded-full flex items-center justify-center text-sm font-bold",children:"3"}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold text-orange-700",children:"ðŸ• Live Tracking"}),e.jsx("p",{className:"text-sm text-gray-600",children:"Your name and timer are logged automatically"})]})]}),e.jsxs("div",{className:"flex items-start gap-3 p-3 bg-white rounded-lg border border-yellow-200",children:[e.jsx("div",{className:"w-8 h-8 bg-red-500 text-white rounded-full flex items-center justify-center text-sm font-bold",children:"4"}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold text-red-700",children:"ðŸ›‘ End & Log Details"}),e.jsx("p",{className:"text-sm text-gray-600",children:'Click "END TEST DRIVE" and fill in client information'})]})]})]}),e.jsx("div",{className:"bg-green-100 p-4 rounded-lg border-2 border-green-300",children:e.jsx("p",{className:"text-sm font-bold text-green-800 text-center",children:"Perfect for quick test drives! No waiting, no forms upfront!"})})]})]})]}),e.jsx(de,{open:Y,onOpenChange:f,children:e.jsxs(me,{className:"max-w-2xl",children:[e.jsx(xe,{children:e.jsxs(he,{className:"flex items-center gap-2 text-red-600",children:[e.jsx(B,{className:"h-6 w-6"}),"ðŸ›‘ Complete Test Drive - Log Client Details"]})}),l&&e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"p-4 bg-blue-50 rounded-lg border-2 border-blue-200",children:[e.jsxs("h4",{className:"font-semibold mb-3 text-blue-700 flex items-center gap-2",children:[e.jsx(Z,{className:"w-4 h-4"}),"Test Drive Summary"]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Vehicle:"}),e.jsx("p",{className:"font-semibold",children:l.carModel})]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"VIN:"}),e.jsx("p",{className:"font-mono",children:l.vin})]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Taken by:"}),e.jsx("p",{className:"font-semibold text-blue-600",children:l.employeeScanned})]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Duration:"}),e.jsx("p",{className:"font-bold text-green-600",children:U(l.startTime)})]})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs(g,{className:"text-base font-semibold flex items-center gap-2",children:[e.jsx(A,{className:"w-4 h-4"}),"Test Drive Type"]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(d,{variant:a.isClientTestDrive?"default":"outline",onClick:()=>u(t=>({...t,isClientTestDrive:!0})),className:"flex-1",children:[e.jsx(P,{className:"h-4 w-4 mr-2"}),"Client Test Drive"]}),e.jsx(d,{variant:a.isClientTestDrive?"outline":"default",onClick:()=>u(t=>({...t,isClientTestDrive:!1})),className:"flex-1",children:"ðŸ‘¨â€ðŸ’¼ Employee Test Drive"})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsxs(g,{htmlFor:"driverName",className:"text-base font-semibold flex items-center gap-2",children:[e.jsx(P,{className:"w-4 h-4"}),"Driver Name *"]}),e.jsx(_,{id:"driverName",value:a.driverName,onChange:t=>u(s=>({...s,driverName:t.target.value})),placeholder:"Who actually drove the vehicle?",className:"h-12"})]}),a.isClientTestDrive&&e.jsxs("div",{children:[e.jsxs(g,{htmlFor:"clientName",className:"text-base font-semibold flex items-center gap-2",children:[e.jsx(q,{className:"w-4 h-4"}),"Client Name *"]}),e.jsx(_,{id:"clientName",value:a.clientName,onChange:t=>u(s=>({...s,clientName:t.target.value})),placeholder:"Client's full name",className:"h-12"})]}),e.jsxs("div",{children:[e.jsxs(g,{htmlFor:"testDriveNotes",className:"text-base font-semibold flex items-center gap-2",children:[e.jsx(Z,{className:"w-4 h-4"}),"Test Drive Notes"]}),e.jsx(ue,{id:"testDriveNotes",value:a.testDriveNotes,onChange:t=>u(s=>({...s,testDriveNotes:t.target.value})),placeholder:"How was the test drive? Any observations, client feedback, issues...",rows:4,className:"text-base"})]})]}),e.jsxs("div",{className:"flex gap-3 justify-end pt-4 border-t",children:[e.jsx(d,{variant:"outline",onClick:()=>f(!1),className:"px-6",children:"Cancel"}),e.jsxs(d,{onClick:se,className:"bg-green-600 hover:bg-green-700 text-white px-8 py-3 text-base font-bold",children:[e.jsx(Ne,{className:"h-5 w-5 mr-2"}),"COMPLETE TEST DRIVE"]})]})]})]})})]})};export{Te as default};
