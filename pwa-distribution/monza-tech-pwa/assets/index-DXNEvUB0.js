import{r as l,j as e,ab as w,g as I,h as u,Q as q,L as P,I as C,aN as M,aH as $,ao as A,$ as L,aO as Q}from"./index-D4jk50_k.js";import{S as T,e as U,P as z}from"./PartNumberScannerDialog-jZvH0eH-.js";import{R as E}from"./rotate-ccw-BXXSfL53.js";import{i as R}from"./inventoryService-DVpHZoL-.js";import"./loader-2-IVJBxzIH.js";const B=({scanning:N,onStartScanner:b,onStopScanner:h,toast:n})=>{const t=l.useRef(null),x=l.useRef(null),c=l.useRef(null),[o,r]=l.useState(null),[i,p]=l.useState(!1),[d,v]=l.useState(""),[m,f]=l.useState(!1),g=async()=>{if(t.current)try{console.log("Starting part scanner camera...");const s=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment",width:{ideal:1280},height:{ideal:720}}});c.current=s,t.current.srcObject=s,await t.current.play(),f(!0),b(),n({title:"Camera started",description:"Position the part number clearly in the frame and capture"})}catch(s){console.error("Error accessing camera:",s),n({title:"Camera error",description:"Could not access the camera. Please check permissions.",variant:"destructive"})}},S=()=>{c.current&&(c.current.getTracks().forEach(s=>s.stop()),c.current=null),t.current&&(t.current.srcObject=null),f(!1),r(null),v(""),h()},F=()=>{if(!t.current||!x.current)return;const s=t.current,a=x.current,j=a.getContext("2d");if(!j)return;a.width=s.videoWidth,a.height=s.videoHeight,j.drawImage(s,0,0,a.width,a.height);const k=a.toDataURL("image/jpeg",.8);r(k),c.current&&(c.current.getTracks().forEach(V=>V.stop()),c.current=null),f(!1),n({title:"Photo captured",description:"Processing with OCR to extract part number..."}),D(k)},D=async s=>{p(!0);try{const a=await U(s);if(a&&a.trim()){v(a);const j=new CustomEvent("partNumberScanned",{detail:{partNumber:a}});window.dispatchEvent(j),n({title:"Part number detected",description:`Successfully extracted: ${a}`})}else n({title:"No part number detected",description:"Please try capturing again with better lighting and focus.",variant:"destructive"})}catch(a){console.error("Part number OCR error:",a),n({title:"OCR processing failed",description:"Failed to read part number. Please try again or enter manually.",variant:"destructive"})}finally{p(!1)}},O=()=>{if(d.trim()){const s=new CustomEvent("partNumberConfirmed",{detail:{partNumber:d}});window.dispatchEvent(s),n({title:"Part number confirmed",description:`Part number ${d} registered as arrived`}),y()}},y=()=>{r(null),v(""),g()};return l.useEffect(()=>()=>{S()},[]),e.jsxs("div",{className:"bg-white rounded-lg border shadow-sm p-4 md:p-6",children:[e.jsxs("div",{className:"text-center mb-4 md:mb-6",children:[e.jsx(T,{className:"mx-auto h-8 w-8 md:h-12 md:w-12 text-primary mb-2"}),e.jsx("h2",{className:"text-lg md:text-xl font-semibold",children:"Part Number Scanner"}),e.jsx("p",{className:"text-xs md:text-sm text-muted-foreground",children:"Scan part numbers to register their arrival in inventory"})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsxs("div",{className:"w-full aspect-video bg-slate-100 rounded-md overflow-hidden mb-4 relative",children:[m&&!o?e.jsxs(e.Fragment,{children:[e.jsx("video",{ref:t,className:"w-full h-full object-cover",playsInline:!0,muted:!0}),e.jsxs("div",{className:"absolute inset-0 pointer-events-none",children:[e.jsx("div",{className:"absolute inset-0 bg-black bg-opacity-40"}),e.jsx("div",{className:"absolute inset-0 flex items-center justify-center",children:e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"w-64 h-16 border-2 border-white border-dashed bg-transparent rounded-lg"}),e.jsx("div",{className:"absolute -top-2 -left-2 w-6 h-6 border-l-4 border-t-4 border-green-400 rounded-tl-lg"}),e.jsx("div",{className:"absolute -top-2 -right-2 w-6 h-6 border-r-4 border-t-4 border-green-400 rounded-tr-lg"}),e.jsx("div",{className:"absolute -bottom-2 -left-2 w-6 h-6 border-l-4 border-b-4 border-green-400 rounded-bl-lg"}),e.jsx("div",{className:"absolute -bottom-2 -right-2 w-6 h-6 border-r-4 border-b-4 border-green-400 rounded-br-lg"})]})}),e.jsx("div",{className:"absolute bottom-4 left-0 right-0 text-center",children:e.jsx("p",{className:"text-white text-sm font-medium bg-black bg-opacity-60 rounded-full px-4 py-2 mx-4",children:"Position part number clearly in the target area"})})]})]}):o?e.jsxs("div",{className:"relative w-full h-full",children:[e.jsx("img",{src:o,alt:"Captured Part",className:"w-full h-full object-cover"}),i&&e.jsx("div",{className:"absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center",children:e.jsxs("div",{className:"bg-white rounded-lg p-4 flex items-center gap-3",children:[e.jsx("div",{className:"h-5 w-5 animate-spin rounded-full border-2 border-current border-t-transparent"}),e.jsx("span",{className:"text-sm font-medium",children:"Processing with OCR..."})]})})]}):e.jsxs("div",{className:"flex flex-col items-center justify-center h-full text-muted-foreground",children:[e.jsx(w,{className:"h-8 w-8 md:h-12 md:w-12 opacity-30 mb-2"}),e.jsx("p",{className:"text-sm",children:'Click "Start Camera" to begin scanning'}),e.jsx("p",{className:"text-xs mt-1",children:"Position part number clearly for best results"})]}),e.jsx("canvas",{ref:x,className:"hidden"})]}),d&&e.jsxs("div",{className:"w-full mb-4 bg-green-50 border border-green-200 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(I,{className:"h-4 w-4 text-green-600"}),e.jsx("span",{className:"text-sm font-medium text-green-700",children:"Part Number Detected"})]}),e.jsx("div",{className:"bg-white rounded px-3 py-2 border",children:e.jsx("span",{className:"font-mono font-semibold text-lg",children:d})})]}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-2 w-full",children:[!m&&!o&&e.jsxs(u,{onClick:g,className:"flex-1 text-sm md:text-base",disabled:i,children:[e.jsx(w,{className:"mr-2 h-4 w-4"}),"Start Camera"]}),m&&!o&&e.jsxs(e.Fragment,{children:[e.jsx(u,{onClick:S,variant:"outline",className:"flex-1 text-sm md:text-base",disabled:i,children:"Cancel"}),e.jsxs(u,{onClick:F,className:"flex-1 text-sm md:text-base",disabled:i,children:[e.jsx(w,{className:"mr-2 h-4 w-4"}),"Capture Photo"]})]}),o&&!d&&!i&&e.jsxs(u,{onClick:y,variant:"outline",className:"flex-1 text-sm md:text-base",children:[e.jsx(E,{className:"mr-2 h-4 w-4"}),"Retake Photo"]}),d&&e.jsxs(e.Fragment,{children:[e.jsxs(u,{onClick:y,variant:"outline",className:"flex-1 text-sm md:text-base",children:[e.jsx(E,{className:"mr-2 h-4 w-4"}),"Retake Photo"]}),e.jsxs(u,{onClick:O,className:"flex-1 text-sm md:text-base",children:[e.jsx(I,{className:"mr-2 h-4 w-4"}),"Register Arrival"]})]})]})]})]})},H=({manualPartId:N,carVIN:b,quantity:h,onPartIdChange:n,onCarVINChange:t,onQuantityChange:x,onSubmit:c})=>{const o=r=>{n(r)};return e.jsxs("div",{className:"bg-white rounded-lg border shadow-sm p-4 md:p-6",children:[e.jsxs("div",{className:"text-center mb-4 md:mb-6",children:[e.jsx(q,{className:"mx-auto h-8 w-8 md:h-12 md:w-12 text-primary mb-2"}),e.jsx("h2",{className:"text-lg md:text-xl font-semibold",children:"Manual Entry"}),e.jsx("p",{className:"text-xs md:text-sm text-muted-foreground",children:"Enter part details manually or scan part number with camera"})]}),e.jsxs("form",{onSubmit:c,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(P,{htmlFor:"partId",className:"text-sm font-medium",children:"Part ID or Number"}),e.jsxs("div",{className:"flex gap-2 mt-1",children:[e.jsx(C,{id:"partId",value:N,onChange:r=>n(r.target.value),placeholder:"Enter part ID or number",className:"flex-1",required:!0}),e.jsx(z,{onPartNumberScanned:o,children:e.jsx(u,{variant:"outline",size:"sm",type:"button",children:e.jsx(w,{className:"h-4 w-4"})})})]})]}),e.jsxs("div",{children:[e.jsx(P,{htmlFor:"carVIN",className:"text-sm font-medium",children:"Car VIN"}),e.jsx(C,{id:"carVIN",value:b,onChange:r=>t(r.target.value),placeholder:"Enter vehicle VIN",className:"mt-1",required:!0})]}),e.jsxs("div",{children:[e.jsx(P,{htmlFor:"quantity",className:"text-sm font-medium",children:"Quantity"}),e.jsx(C,{id:"quantity",type:"number",min:"1",value:h,onChange:r=>x(M(r.target.value,1)),className:"mt-1",required:!0})]}),e.jsx(u,{type:"submit",className:"w-full",children:"Check Out Part"})]})]})},X=()=>{const[N,b]=l.useState(!1),[h,n]=l.useState(""),[t,x]=l.useState(""),[c,o]=l.useState(1),r=$(),{toast:i}=A(),{user:p}=L(),d=m=>{if(m.preventDefault(),h.trim().length<3){i({title:"Invalid Part ID",description:"Please enter a valid Part ID or Number.",variant:"destructive"});return}if(t.trim().length<5){i({title:"Invalid VIN",description:"Please enter a valid Vehicle Identification Number.",variant:"destructive"});return}v(h.trim())},v=m=>{try{if(!R.usePart(m,c,{carVIN:t,employee:(p==null?void 0:p.name)||"Unknown",type:"scan",context:"part_scan"})){i({title:"Part Checkout Failed",description:"Failed to process part checkout. Check if part exists and has sufficient quantity.",variant:"destructive"});return}const g=R.findPart(m);i({title:"Part checked out",description:`${c} x ${(g==null?void 0:g.partName)||m} has been checked out for car ${t}. Inventory updated.`}),n(""),x(""),o(1),r("/inventory-history")}catch(f){console.error("Error processing part checkout:",f),i({title:"Error",description:"Failed to process part checkout.",variant:"destructive"})}};return e.jsxs("div",{className:"container mx-auto py-4 md:py-6 px-4",children:[e.jsxs("div",{className:"flex items-center mb-4 md:mb-6",children:[e.jsxs(u,{variant:"outline",size:"sm",className:"mr-3 md:mr-4",onClick:()=>r(-1),children:[e.jsx(Q,{className:"mr-1 h-4 w-4"}),"Back"]}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-xl md:text-2xl font-bold tracking-tight",children:"Scan Part"}),e.jsx("p",{className:"text-sm md:text-base text-muted-foreground mt-1",children:"Scan parts to check them out from inventory"})]})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-4 md:gap-6",children:[e.jsx(B,{scanning:N,onStartScanner:()=>b(!0),onStopScanner:()=>b(!1),toast:i}),e.jsx(H,{manualPartId:h,carVIN:t,quantity:c,onPartIdChange:n,onCarVINChange:x,onQuantityChange:o,onSubmit:d})]})]})};export{X as default};
