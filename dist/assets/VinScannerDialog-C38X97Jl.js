const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/cleanMoveCarService-W7bZHGm6.js","assets/index-BmUpYGrm.js","assets/vendor-vN6PtkFd.js","assets/charts-XrXYWaKo.js","assets/utils-DhcIvS4g.js","assets/index-wQIKT8W8.css"])))=>i.map(i=>d[i]);
var e=Object.defineProperty,t=Object.defineProperties,s=Object.getOwnPropertyDescriptors,r=Object.getOwnPropertySymbols,a=Object.prototype.hasOwnProperty,n=Object.prototype.propertyIsEnumerable,i=(t,s,r)=>s in t?e(t,s,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[s]=r,l=(e,t,s)=>new Promise((r,a)=>{var n=e=>{try{l(s.next(e))}catch(t){a(t)}},i=e=>{try{l(s.throw(e))}catch(t){a(t)}},l=e=>e.done?r(e.value):Promise.resolve(e.value).then(n,i);l((s=s.apply(e,t)).next())});import{t as c,j as d,y as o,z as m,E as x,F as u,b as h,V as g,e as p,D as v,x as b,m as j,X as N,k as y,Q as f,s as w,a1 as _}from"./index-BmUpYGrm.js";import{r as C}from"./vendor-vN6PtkFd.js";import{u as I}from"./cameraPermissionManager-D3sOAAEG.js";import{e as V}from"./ocrUtils-boR-SCDU.js";import{C as S}from"./camera-CKQtJJJ8.js";import{B as P}from"./battery-zPCpHw5W.js";import{F as E}from"./file-text-bXPYLusF.js";import{A as k}from"./arrow-left-DqrDEplE.js";const A=e=>({Inventory:"CAR_INVENTORY","Showroom Floor 1":"SHOWROOM_1","Showroom Floor 2":"SHOWROOM_2",Garage:"GARAGE_INVENTORY",External:"SCHEDULE"}[e]||"CAR_INVENTORY"),F=({isOpen:e,onClose:F,onVinScanned:O,targetLocation:D="Inventory",onCarMoved:R,onCarAdded:U,onTestDrive:$,onPdiAction:H})=>{const[T,L]=C.useState(!1),[M,B]=C.useState(!1),[Y,J]=C.useState(null),[Z,G]=C.useState(null),[q,z]=C.useState(!1),W=C.useRef(null),Q=C.useRef(null),{granted:K,denied:X,stream:ee,requestCamera:te,stopCamera:se,isSupported:re,hasActiveStream:ae}=I(),ne=/^[A-HJ-NPR-Z0-9]{17}$/;C.useEffect(()=>{e&&K&&!ae&&!q?ie():!e||K||X||q?e||(se(),J(null),B(!1),G(null),z(!1)):ie()},[e,K,X,ae,q]),C.useEffect(()=>{W.current&&ee&&(W.current.srcObject=ee,W.current.play().catch(console.error))},[ee]);const ie=()=>l(void 0,null,function*(){if(re)try{L(!0),yield te({video:{facingMode:"environment"}}),c({title:"Camera Active",description:"Position the VIN clearly in the camera view."})}catch(e){let t="Could not access the camera.";e instanceof Error&&(t="NotAllowedError"===e.name?"Camera permission denied. Please allow camera access and try again.":"NotFoundError"===e.name?"No camera found on this device.":"NotSupportedError"===e.name?"Camera not supported on this browser.":e.message),c({title:"Camera Access Error",description:t,variant:"destructive"})}finally{L(!1)}else c({title:"Camera Not Supported",description:"Camera access is not supported on this device or browser.",variant:"destructive"})}),le=()=>{if(!W.current||!Q.current)return void c({title:"Camera not ready",description:"Please ensure the camera is active before capturing.",variant:"destructive"});const e=W.current,t=Q.current,s=t.getContext("2d");if(!s)return void c({title:"Canvas error",description:"Unable to capture photo. Please try again.",variant:"destructive"});t.width=e.videoWidth,t.height=e.videoHeight,s.drawImage(e,0,0,t.width,t.height);const r=t.toDataURL("image/jpeg",.9);J(r),c({title:"Photo captured",description:"Photo captured! Click 'Extract VIN' to read the VIN using OCR."})},ce=e=>l(void 0,null,function*(){var d,o,m,x,u,h,g,p;if(ne.test(e))try{const{data:b}=yield w.from("car_inventory").select("\n          *,\n          pdi_inspections(*),\n          test_drives(*)\n        ").eq("vin",e).single();if(b){const t={id:b.id,vin_number:b.vin,brand:b.brand||"Unknown",model:b.model||"Unknown Model",year:b.year||(new Date).getFullYear(),color:b.color||"Unknown",category:b.category||"EV",status:b.status||"in_stock",current_location:b.current_location||"Unknown",selling_price:b.selling_price||0,battery_percentage:b.battery_percentage||100,range_km:b.range_km||0,arrival_date:b.arrival_date||b.created_at,customs:b.customs||"not_paid",pdi_completed:(null==(d=b.pdi_inspections)?void 0:d.some(e=>"completed"===e.status))||!1,pdi_technician:(null==(m=null==(o=b.pdi_inspections)?void 0:o.find(e=>"completed"===e.status))?void 0:m.technician_name)||void 0,pdi_date:(null==(u=null==(x=b.pdi_inspections)?void 0:x.find(e=>"completed"===e.status))?void 0:u.completion_date)||void 0,notes:b.notes||void 0,test_drive_status:(null==(h=b.test_drives)?void 0:h.some(e=>!0===e.is_active))||!1,created_at:b.created_at,updated_at:b.updated_at},s=A(D),{moveCarByVin:r}=yield _(()=>l(void 0,null,function*(){const{moveCarByVin:e}=yield import("./cleanMoveCarService-W7bZHGm6.js");return{moveCarByVin:e}}),__vite__mapDeps([0,1,2,3,4,5]));try{yield r(e,s),c({title:"Car Moved Successfully!",description:`${t.brand} ${t.model} moved to ${D}`})}catch(v){c({title:"Car Found but Move Failed",description:`Found ${t.brand} ${t.model} but failed to move to ${D}`,variant:"destructive"})}G(t),z(!0),se(),O(e)}else{const l={vin_number:e,model:`Unknown Model (${e.slice(-4)})`,brand:"Unknown",year:(new Date).getFullYear(),color:"To be determined",category:"EV",status:"in_stock",current_floor:A(D),selling_price:0,arrival_date:(new Date).toISOString(),showroom_entry_date:D.includes("Showroom")?(new Date).toISOString():null,garage_entry_date:"Garage"===D?(new Date).toISOString():null,customs:"not_paid",notes:`Added via VIN scanner to ${D}`,created_at:(new Date).toISOString(),updated_at:(new Date).toISOString()},{data:d,error:o}=yield w.from("car_inventory").insert(l).select().single();if(o)throw o;const m=(g=((e,t)=>{for(var s in t||(t={}))a.call(t,s)&&i(e,s,t[s]);if(r)for(var s of r(t))n.call(t,s)&&i(e,s,t[s]);return e})({},l),p={id:d.id,battery_percentage:100,range_km:0,pdi_completed:!1,test_drive_status:!1},t(g,s(p)));G(m),z(!0),se(),c({title:"New Car Added",description:`Vehicle with VIN ${e} added to ${D}.`}),O(e),null==U||U(d.id)}}catch(b){c({title:"Database Error",description:b.message||"Failed to process VIN in database",variant:"destructive"})}else c({title:"Invalid VIN Format",description:"The scanned text does not appear to be a valid VIN.",variant:"destructive"})}),de=()=>{se(),J(null),B(!1),G(null),z(!1),F()},oe=e=>e?new Date(e).toLocaleDateString("en-US",{year:"numeric",month:"short",day:"numeric"}):"N/A";return d.jsx(o,{open:e,onOpenChange:de,children:d.jsxs(m,{className:q?"max-w-4xl w-[95vw] max-h-[95vh] overflow-y-auto":"max-w-2xl w-[95vw] max-h-[95vh] overflow-y-auto",children:[d.jsxs(x,{className:"sticky top-0 bg-white z-10 border-b pb-4",children:[d.jsx(u,{className:"flex items-center gap-2",children:q?d.jsxs(d.Fragment,{children:[d.jsx(h,{className:"h-5 w-5"}),"Vehicle Information & Actions"]}):d.jsxs(d.Fragment,{children:[d.jsx(S,{className:"h-5 w-5"}),"Scan VIN - Add to ",D]})}),!q&&d.jsxs("div",{className:"flex items-center gap-2 text-sm text-muted-foreground",children:[d.jsx(g,{className:"h-4 w-4"}),"Target Location: ",d.jsx("span",{className:"font-medium text-blue-600",children:D})]})]}),d.jsx("div",{className:"px-1",children:q?Z&&d.jsxs("div",{className:"space-y-6",children:[d.jsxs("div",{className:"bg-gradient-to-r from-blue-50 to-green-50 border border-blue-200 rounded-lg p-4",children:[d.jsxs("div",{className:"flex items-start justify-between mb-3",children:[d.jsxs("div",{children:[d.jsxs("h3",{className:"text-xl font-bold text-gray-900",children:[Z.brand," ",Z.model]}),d.jsx("p",{className:"text-gray-600 font-mono text-sm",children:Z.vin_number})]}),d.jsxs("div",{className:"flex gap-2",children:[d.jsx(p,{className:(e=>{switch(e){case"EV":return"category-ev";case"REV":return"category-rev";case"ICEV":return"category-icev";default:return"bg-gray-400 text-white"}})(Z.category),children:Z.category}),d.jsx(p,{className:(e=>{switch(e){case"in_stock":return"bg-green-100 text-green-800 border-green-200";case"sold":return"bg-blue-100 text-blue-800 border-blue-200";case"reserved":return"bg-yellow-100 text-yellow-800 border-yellow-200";default:return"bg-gray-100 text-gray-800 border-gray-200"}})(Z.status),children:Z.status.replace("_"," ").toUpperCase()})]})]}),d.jsxs("div",{className:"grid grid-cols-3 gap-4 text-sm",children:[d.jsxs("div",{children:[d.jsx("span",{className:"text-gray-500",children:"Year:"}),d.jsx("p",{className:"font-medium",children:Z.year})]}),d.jsxs("div",{children:[d.jsx("span",{className:"text-gray-500",children:"Color:"}),d.jsx("p",{className:"font-medium",children:Z.color})]}),d.jsxs("div",{children:[d.jsx("span",{className:"text-gray-500",children:"Location:"}),d.jsx("p",{className:"font-medium text-blue-600",children:Z.current_location})]})]})]}),d.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[d.jsxs("div",{className:"bg-white border border-gray-200 rounded-lg p-3",children:[d.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[d.jsx(v,{className:"h-4 w-4 text-green-600"}),d.jsx("span",{className:"text-sm font-medium text-gray-700",children:"Price"})]}),d.jsx("p",{className:"text-lg font-bold text-green-600",children:(me=Z.selling_price,me?new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",minimumFractionDigits:0,maximumFractionDigits:0}).format(me):"$0")})]}),d.jsxs("div",{className:"bg-white border border-gray-200 rounded-lg p-3",children:[d.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[d.jsx(P,{className:"h-4 w-4 text-blue-600"}),d.jsx("span",{className:"text-sm font-medium text-gray-700",children:"Battery"})]}),d.jsxs("p",{className:"text-lg font-bold text-blue-600",children:[Z.battery_percentage||0,"%"]}),d.jsxs("p",{className:"text-xs text-gray-500",children:["Range: ",Z.range_km||0," km"]})]})]}),d.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[d.jsxs("div",{className:"bg-white border border-gray-200 rounded-lg p-3",children:[d.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[d.jsx(E,{className:"h-4 w-4 text-purple-600"}),d.jsx("span",{className:"text-sm font-medium text-gray-700",children:"PDI Status"})]}),d.jsx(p,{className:Z.pdi_completed?"bg-green-100 text-green-800":"bg-yellow-100 text-yellow-800",children:Z.pdi_completed?d.jsxs(d.Fragment,{children:[d.jsx("span",{className:"mr-1 text-lg",children:"☺"})," Complete"]}):d.jsxs(d.Fragment,{children:[d.jsx("span",{className:"mr-1 text-lg",children:"☹"})," Pending"]})}),Z.pdi_technician&&d.jsxs("p",{className:"text-xs text-gray-500 mt-1",children:["By: ",Z.pdi_technician]})]}),d.jsxs("div",{className:"bg-white border border-gray-200 rounded-lg p-3",children:[d.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[d.jsx(h,{className:"h-4 w-4 text-orange-600"}),d.jsx("span",{className:"text-sm font-medium text-gray-700",children:"Test Drive"})]}),d.jsx(p,{className:Z.test_drive_status?"bg-blue-100 text-blue-800":"bg-gray-100 text-gray-600",children:Z.test_drive_status?"Active":"Available"})]})]}),d.jsxs("div",{className:"bg-white border border-gray-200 rounded-lg p-3",children:[d.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[d.jsx(b,{className:"h-4 w-4 text-gray-600"}),d.jsx("span",{className:"text-sm font-medium text-gray-700",children:"Customs & Documentation"})]}),d.jsx(p,{variant:"paid"===Z.customs?"default":"destructive",children:"paid"===Z.customs?d.jsxs(d.Fragment,{children:[d.jsx(j,{className:"mr-1 h-4 w-4"})," Paid"]}):d.jsxs(d.Fragment,{children:[d.jsx(N,{className:"mr-1 h-4 w-4"})," ",Z.customs.replace("_"," ")]})})]}),d.jsxs("div",{className:"bg-white border border-gray-200 rounded-lg p-3",children:[d.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[d.jsx(Clock,{className:"h-4 w-4 text-gray-600"}),d.jsx("span",{className:"text-sm font-medium text-gray-700",children:"Important Dates"})]}),d.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[d.jsxs("div",{children:[d.jsx("span",{className:"text-gray-500",children:"Arrival:"}),d.jsx("p",{className:"font-medium",children:oe(Z.arrival_date)})]}),Z.pdi_date&&d.jsxs("div",{children:[d.jsx("span",{className:"text-gray-500",children:"PDI Completed:"}),d.jsx("p",{className:"font-medium",children:oe(Z.pdi_date)})]})]})]}),Z.notes&&d.jsxs("div",{className:"bg-white border border-gray-200 rounded-lg p-3",children:[d.jsx("h4",{className:"text-sm font-medium text-gray-700 mb-2",children:"Notes"}),d.jsx("p",{className:"text-sm text-gray-600",children:Z.notes})]}),d.jsx("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-3",children:d.jsxs("p",{className:"text-sm text-blue-700 text-center",children:[d.jsx("strong",{children:"Actions Available:"})," Test Drive and PDI management can be accessed directly from the main inventory table via clickable badges."]})}),d.jsxs("div",{className:"flex justify-between pt-4 border-t",children:[d.jsxs(y,{variant:"outline",onClick:()=>{z(!1),G(null),J(null),K&&ie()},className:"flex items-center gap-2",children:[d.jsx(k,{className:"h-4 w-4"}),"Scan Another VIN"]}),d.jsx(y,{variant:"outline",onClick:de,children:"Close"})]})]}):d.jsxs("div",{className:"space-y-4",children:[d.jsxs("div",{className:"space-y-4",children:[d.jsxs("div",{className:"relative",children:[Y?d.jsx("img",{src:Y,alt:"Captured VIN",className:"w-full h-64 rounded-md object-contain border-2 border-blue-200"}):d.jsxs(d.Fragment,{children:[d.jsx("video",{ref:W,className:"w-full h-64 rounded-md bg-gray-100 object-cover border-2 border-blue-200",autoPlay:!0,playsInline:!0,muted:!0}),d.jsx("canvas",{ref:Q,className:"hidden"})]}),!ae&&!Y&&d.jsx("div",{className:"absolute inset-0 flex items-center justify-center bg-gray-100 rounded-md",children:d.jsxs("div",{className:"text-center",children:[d.jsx(S,{className:"mx-auto h-12 w-12 text-gray-400 mb-2"}),d.jsx("p",{className:"text-sm text-gray-500",children:T?"Starting camera...":M?"Processing image...":X?"Camera permission denied":re?ae?"Camera active":K?"Camera ready":"Camera access required":"Camera not supported"})]})}),ae&&!Y&&d.jsx("div",{className:"absolute top-3 left-3",children:d.jsxs("div",{className:"flex items-center gap-2 bg-red-500 text-white px-2 py-1 rounded-full text-xs font-medium",children:[d.jsx("div",{className:"w-2 h-2 bg-white rounded-full animate-pulse"}),"LIVE"]})}),!Y&&d.jsx("div",{className:"absolute inset-0 flex items-center justify-center pointer-events-none",children:d.jsx("div",{className:"border-2 border-blue-500 border-dashed rounded-lg p-6 bg-blue-500/10",children:d.jsx("p",{className:"text-blue-600 text-base font-medium bg-white/90 px-3 py-2 rounded shadow-sm",children:"Position VIN number here"})})})]}),d.jsx("div",{className:"text-center space-y-2",children:Y?d.jsxs(d.Fragment,{children:[d.jsx("p",{className:"text-sm text-muted-foreground",children:"Photo captured! Click below to extract VIN or retake"}),d.jsxs("div",{className:"flex gap-2",children:[d.jsx(y,{variant:"outline",onClick:()=>J(null),className:"flex-1",children:"Retake Photo"}),d.jsx(y,{onClick:()=>{var e;Y?(e=Y,l(void 0,null,function*(){try{B(!0),c({title:"Processing Image",description:"Extracting VIN number using OCR..."});const t=yield V(e);if(!t||t.length<10)throw new Error("No readable text found in image");const s=(e=>{const t=[/\b[A-HJ-NPR-Z0-9]{17}\b/gi,/(?:VIN|V\.I\.N|VEHICLE\s+ID|CHASSIS)[:#\s]*([A-HJ-NPR-Z0-9]{17})/gi];for(const s of t){const t=e.match(s);if(t)for(const e of t){const t=e.replace(/[^A-HJ-NPR-Z0-9]/gi,"").toUpperCase();if(17===t.length&&/^[A-HJ-NPR-Z0-9]{17}$/i.test(t))return t}}return null})(t);if(!s)throw new Error("No valid VIN found in image");yield ce(s)}catch(t){c({title:"VIN Extraction Failed",description:t.message||"Failed to extract VIN from image",variant:"destructive"})}finally{B(!1)}})):le()},disabled:M,className:"flex-1",children:M?d.jsxs(d.Fragment,{children:[d.jsx("div",{className:"mr-2 h-4 w-4 animate-spin rounded-full border-2 border-white border-t-transparent"}),"Processing..."]}):d.jsxs(d.Fragment,{children:[d.jsx(f,{className:"mr-2 h-4 w-4"}),"Extract VIN"]})})]})]}):d.jsxs(d.Fragment,{children:[d.jsx("p",{className:"text-sm text-muted-foreground",children:"Position the VIN clearly in the camera view, then capture"}),ae&&d.jsxs(y,{onClick:le,className:"w-full",children:[d.jsx(S,{className:"mr-2 h-4 w-4"}),"Capture Photo"]})]})})]}),d.jsxs("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-3",children:[d.jsx("h4",{className:"font-medium text-blue-800 text-sm mb-2",children:"Tips for Best Results"}),d.jsxs("ul",{className:"text-xs text-blue-700 space-y-1",children:[d.jsx("li",{children:"• Ensure good lighting on the VIN plate"}),d.jsx("li",{children:"• Hold the camera steady and focus clearly"}),d.jsx("li",{children:"• Position the entire VIN number within the frame"}),d.jsx("li",{children:"• VIN is usually on dashboard, door frame, or engine block"})]})]}),d.jsxs("div",{className:"bg-green-50 border border-green-200 rounded-lg p-3",children:[d.jsxs("div",{className:"flex items-center gap-2",children:[d.jsx(h,{className:"h-4 w-4 text-green-600"}),d.jsxs("span",{className:"font-medium text-green-800 text-sm",children:["Target Location: ",d.jsx("span",{className:"font-bold",children:D})]})]}),d.jsxs("p",{className:"text-xs text-green-700 mt-1",children:["• Found cars will show comprehensive information and action options • New cars will be added directly to ",D]})]}),d.jsx("div",{className:"flex justify-end gap-2 pt-4 border-t",children:d.jsx(y,{variant:"outline",onClick:de,children:"Cancel"})})]})})]})});var me};export{F as V};
