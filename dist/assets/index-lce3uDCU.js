var e=(e,t,r)=>new Promise((a,s)=>{var n=e=>{try{l(r.next(e))}catch(t){s(t)}},i=e=>{try{l(r.throw(e))}catch(t){s(t)}},l=e=>e.done?a(e.value):Promise.resolve(e.value).then(n,i);l((r=r.apply(e,t)).next())});import{j as t,m as r,k as a,a4 as s,Q as n,L as i,I as l,u as c,l as d,K as o}from"./index-BmUpYGrm.js";import{r as m}from"./vendor-vN6PtkFd.js";import{S as u,e as x,P as h}from"./PartNumberScannerDialog-s5LV33ZH.js";import{C as b}from"./camera-CKQtJJJ8.js";import{a as p}from"./errorHandling-Dc1u_gNS.js";import{i as v}from"./inventoryService-BaDJwFj-.js";import{A as g}from"./arrow-left-DqrDEplE.js";import"./charts-XrXYWaKo.js";import"./utils-DhcIvS4g.js";import"./enhancedMonzaBotService-CP3UVEVb.js";import"./loader-2-BYW_3amd.js";const j=({scanning:n,onStartScanner:i,onStopScanner:l,toast:c})=>{const d=m.useRef(null),o=m.useRef(null),h=m.useRef(null),[p,v]=m.useState(null),[g,j]=m.useState(!1),[f,N]=m.useState(""),[w,y]=m.useState(!1),C=()=>e(void 0,null,function*(){if(d.current)try{const e=yield navigator.mediaDevices.getUserMedia({video:{facingMode:"environment",width:{ideal:1280},height:{ideal:720}}});h.current=e,d.current.srcObject=e,yield d.current.play(),y(!0),i(),c({title:"Camera started",description:"Position the part number clearly in the frame and capture"})}catch(e){c({title:"Camera error",description:"Could not access the camera. Please check permissions.",variant:"destructive"})}}),P=()=>{h.current&&(h.current.getTracks().forEach(e=>e.stop()),h.current=null),d.current&&(d.current.srcObject=null),y(!1),v(null),N(""),l()},S=t=>e(void 0,null,function*(){j(!0);try{const e=yield x(t);if(e&&e.trim()){N(e);const t=new CustomEvent("partNumberScanned",{detail:{partNumber:e}});window.dispatchEvent(t),c({title:"Part number detected",description:`Successfully extracted: ${e}`})}else c({title:"No part number detected",description:"Please try capturing again with better lighting and focus.",variant:"destructive"})}catch(e){c({title:"OCR processing failed",description:"Failed to read part number. Please try again or enter manually.",variant:"destructive"})}finally{j(!1)}}),k=()=>{v(null),N(""),C()};return m.useEffect(()=>()=>{P()},[]),t.jsxs("div",{className:"bg-white rounded-lg border shadow-sm p-4 md:p-6",children:[t.jsxs("div",{className:"text-center mb-4 md:mb-6",children:[t.jsx(u,{className:"mx-auto h-8 w-8 md:h-12 md:w-12 text-primary mb-2"}),t.jsx("h2",{className:"text-lg md:text-xl font-semibold",children:"Part Number Scanner"}),t.jsx("p",{className:"text-xs md:text-sm text-muted-foreground",children:"Scan part numbers to register their arrival in inventory"})]}),t.jsxs("div",{className:"flex flex-col items-center",children:[t.jsxs("div",{className:"w-full aspect-video bg-slate-100 rounded-md overflow-hidden mb-4 relative",children:[w&&!p?t.jsxs(t.Fragment,{children:[t.jsx("video",{ref:d,className:"w-full h-full object-cover",playsInline:!0,muted:!0}),t.jsxs("div",{className:"absolute inset-0 pointer-events-none",children:[t.jsx("div",{className:"absolute inset-0 bg-black bg-opacity-40"}),t.jsx("div",{className:"absolute inset-0 flex items-center justify-center",children:t.jsxs("div",{className:"relative",children:[t.jsx("div",{className:"w-64 h-16 border-2 border-white border-dashed bg-transparent rounded-lg"}),t.jsx("div",{className:"absolute -top-2 -left-2 w-6 h-6 border-l-4 border-t-4 border-green-400 rounded-tl-lg"}),t.jsx("div",{className:"absolute -top-2 -right-2 w-6 h-6 border-r-4 border-t-4 border-green-400 rounded-tr-lg"}),t.jsx("div",{className:"absolute -bottom-2 -left-2 w-6 h-6 border-l-4 border-b-4 border-green-400 rounded-bl-lg"}),t.jsx("div",{className:"absolute -bottom-2 -right-2 w-6 h-6 border-r-4 border-b-4 border-green-400 rounded-br-lg"})]})}),t.jsx("div",{className:"absolute bottom-4 left-0 right-0 text-center",children:t.jsx("p",{className:"text-white text-sm font-medium bg-black bg-opacity-60 rounded-full px-4 py-2 mx-4",children:"Position part number clearly in the target area"})})]})]}):p?t.jsxs("div",{className:"relative w-full h-full",children:[t.jsx("img",{src:p,alt:"Captured Part",className:"w-full h-full object-cover"}),g&&t.jsx("div",{className:"absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center",children:t.jsxs("div",{className:"bg-white rounded-lg p-4 flex items-center gap-3",children:[t.jsx("div",{className:"h-5 w-5 animate-spin rounded-full border-2 border-current border-t-transparent"}),t.jsx("span",{className:"text-sm font-medium",children:"Processing with OCR..."})]})})]}):t.jsxs("div",{className:"flex flex-col items-center justify-center h-full text-muted-foreground",children:[t.jsx(b,{className:"h-8 w-8 md:h-12 md:w-12 opacity-30 mb-2"}),t.jsx("p",{className:"text-sm",children:'Click "Start Camera" to begin scanning'}),t.jsx("p",{className:"text-xs mt-1",children:"Position part number clearly for best results"})]}),t.jsx("canvas",{ref:o,className:"hidden"})]}),f&&t.jsxs("div",{className:"w-full mb-4 bg-green-50 border border-green-200 rounded-lg p-4",children:[t.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[t.jsx(r,{className:"h-4 w-4 text-green-600"}),t.jsx("span",{className:"text-sm font-medium text-green-700",children:"Part Number Detected"})]}),t.jsx("div",{className:"bg-white rounded px-3 py-2 border",children:t.jsx("span",{className:"font-mono font-semibold text-lg",children:f})})]}),t.jsxs("div",{className:"flex flex-col sm:flex-row gap-2 w-full",children:[!w&&!p&&t.jsxs(a,{onClick:C,className:"flex-1 text-sm md:text-base",disabled:g,children:[t.jsx(b,{className:"mr-2 h-4 w-4"}),"Start Camera"]}),w&&!p&&t.jsxs(t.Fragment,{children:[t.jsx(a,{onClick:P,variant:"outline",className:"flex-1 text-sm md:text-base",disabled:g,children:"Cancel"}),t.jsxs(a,{onClick:()=>{if(!d.current||!o.current)return;const e=d.current,t=o.current,r=t.getContext("2d");if(!r)return;t.width=e.videoWidth,t.height=e.videoHeight,r.drawImage(e,0,0,t.width,t.height);const a=t.toDataURL("image/jpeg",.8);v(a),h.current&&(h.current.getTracks().forEach(e=>e.stop()),h.current=null),y(!1),c({title:"Photo captured",description:"Processing with OCR to extract part number..."}),S(a)},className:"flex-1 text-sm md:text-base",disabled:g,children:[t.jsx(b,{className:"mr-2 h-4 w-4"}),"Capture Photo"]})]}),p&&!f&&!g&&t.jsxs(a,{onClick:k,variant:"outline",className:"flex-1 text-sm md:text-base",children:[t.jsx(s,{className:"mr-2 h-4 w-4"}),"Retake Photo"]}),f&&t.jsxs(t.Fragment,{children:[t.jsxs(a,{onClick:k,variant:"outline",className:"flex-1 text-sm md:text-base",children:[t.jsx(s,{className:"mr-2 h-4 w-4"}),"Retake Photo"]}),t.jsxs(a,{onClick:()=>{if(f.trim()){const e=new CustomEvent("partNumberConfirmed",{detail:{partNumber:f}});window.dispatchEvent(e),c({title:"Part number confirmed",description:`Part number ${f} registered as arrived`}),k()}},className:"flex-1 text-sm md:text-base",children:[t.jsx(r,{className:"mr-2 h-4 w-4"}),"Register Arrival"]})]})]})]})]})},f=({manualPartId:e,carVIN:r,quantity:s,onPartIdChange:c,onCarVINChange:d,onQuantityChange:o,onSubmit:m})=>t.jsxs("div",{className:"bg-white rounded-lg border shadow-sm p-4 md:p-6",children:[t.jsxs("div",{className:"text-center mb-4 md:mb-6",children:[t.jsx(n,{className:"mx-auto h-8 w-8 md:h-12 md:w-12 text-primary mb-2"}),t.jsx("h2",{className:"text-lg md:text-xl font-semibold",children:"Manual Entry"}),t.jsx("p",{className:"text-xs md:text-sm text-muted-foreground",children:"Enter part details manually or scan part number with camera"})]}),t.jsxs("form",{onSubmit:m,className:"space-y-4",children:[t.jsxs("div",{children:[t.jsx(i,{htmlFor:"partId",className:"text-sm font-medium",children:"Part ID or Number"}),t.jsxs("div",{className:"flex gap-2 mt-1",children:[t.jsx(l,{id:"partId",value:e,onChange:e=>c(e.target.value),placeholder:"Enter part ID or number",className:"flex-1",required:!0}),t.jsx(h,{onPartNumberScanned:e=>{c(e)},children:t.jsx(a,{variant:"outline",size:"sm",type:"button",children:t.jsx(b,{className:"h-4 w-4"})})})]})]}),t.jsxs("div",{children:[t.jsx(i,{htmlFor:"carVIN",className:"text-sm font-medium",children:"Car VIN"}),t.jsx(l,{id:"carVIN",value:r,onChange:e=>d(e.target.value),placeholder:"Enter vehicle VIN",className:"mt-1",required:!0})]}),t.jsxs("div",{children:[t.jsx(i,{htmlFor:"quantity",className:"text-sm font-medium",children:"Quantity"}),t.jsx(l,{id:"quantity",type:"number",min:"1",value:s,onChange:e=>o(p(e.target.value,1)),className:"mt-1",required:!0})]}),t.jsx(a,{type:"submit",className:"w-full",children:"Check Out Part"})]})]}),N=()=>{const[e,r]=m.useState(!1),[s,n]=m.useState(""),[i,l]=m.useState(""),[u,x]=m.useState(1),h=c(),{toast:b}=d(),{user:p}=o(),N=e=>{try{if(!v.usePart(e,u,{carVIN:i,employee:(null==p?void 0:p.name)||"Unknown",type:"scan",context:"part_scan"}))return void b({title:"Part Checkout Failed",description:"Failed to process part checkout. Check if part exists and has sufficient quantity.",variant:"destructive"});const t=v.findPart(e);b({title:"Part checked out",description:`${u} x ${(null==t?void 0:t.partName)||e} has been checked out for car ${i}. Inventory updated.`}),n(""),l(""),x(1),h("/inventory-history")}catch(t){b({title:"Error",description:"Failed to process part checkout.",variant:"destructive"})}};return t.jsxs("div",{className:"container mx-auto py-4 md:py-6 px-4",children:[t.jsxs("div",{className:"flex items-center mb-4 md:mb-6",children:[t.jsxs(a,{variant:"outline",size:"sm",className:"mr-3 md:mr-4",onClick:()=>h(-1),children:[t.jsx(g,{className:"mr-1 h-4 w-4"}),"Back"]}),t.jsxs("div",{children:[t.jsx("h1",{className:"text-xl md:text-2xl font-bold tracking-tight",children:"Scan Part"}),t.jsx("p",{className:"text-sm md:text-base text-muted-foreground mt-1",children:"Scan parts to check them out from inventory"})]})]}),t.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-4 md:gap-6",children:[t.jsx(j,{scanning:e,onStartScanner:()=>r(!0),onStopScanner:()=>r(!1),toast:b}),t.jsx(f,{manualPartId:s,carVIN:i,quantity:u,onPartIdChange:n,onCarVINChange:l,onQuantityChange:x,onSubmit:e=>{e.preventDefault(),s.trim().length<3?b({title:"Invalid Part ID",description:"Please enter a valid Part ID or Number.",variant:"destructive"}):i.trim().length<5?b({title:"Invalid VIN",description:"Please enter a valid Vehicle Identification Number.",variant:"destructive"}):N(s.trim())}})]})]})};export{N as default};
