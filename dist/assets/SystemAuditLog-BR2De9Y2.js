var e=Object.defineProperty,s=Object.defineProperties,a=Object.getOwnPropertyDescriptors,t=Object.getOwnPropertySymbols,l=Object.prototype.hasOwnProperty,r=Object.prototype.propertyIsEnumerable,n=(s,a,t)=>a in s?e(s,a,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[a]=t,i=(e,s)=>{for(var a in s||(s={}))l.call(s,a)&&n(e,a,s[a]);if(t)for(var a of t(s))r.call(s,a)&&n(e,a,s[a]);return e},c=(e,t)=>s(e,a(t)),d=(e,s)=>{var a={};for(var n in e)l.call(e,n)&&s.indexOf(n)<0&&(a[n]=e[n]);if(null!=e&&t)for(var n of t(e))s.indexOf(n)<0&&r.call(e,n)&&(a[n]=e[n]);return a};import{bi as o,bj as m,j as x,an as h,bk as p,i as j,bl as g,X as u,bm as f,bn as N,bo as y,bp as b,K as v,am as w,aV as _,e as S,k as A,C as E,g as D,h as k,S as L,a as C,I as R,Y as T,Z as O,_ as I,$ as P,a0 as U,n as q,a6 as H,s as $}from"./index-BmUpYGrm.js";import{r as M}from"./vendor-vN6PtkFd.js";import{D as F}from"./download-CLPHGjzE.js";import{f as V}from"./utils-DhcIvS4g.js";import"./charts-XrXYWaKo.js";const z=o,J=m,B=h,K=M.forwardRef((e,s)=>{var a=e,{className:t}=a,l=d(a,["className"]);return x.jsx(y,c(i({className:j("fixed inset-0 z-[1000000] bg-transparent data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",t)},l),{ref:s}))});K.displayName=y.displayName;const W=f("fixed z-[1000001] gap-4 bg-background p-6 shadow-lg transition ease-in-out data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:duration-300 data-[state=open]:duration-500",{variants:{side:{top:"inset-x-0 top-0 border-b data-[state=closed]:slide-out-to-top data-[state=open]:slide-in-from-top",bottom:"inset-x-0 bottom-0 border-t data-[state=closed]:slide-out-to-bottom data-[state=open]:slide-in-from-bottom",left:"inset-y-0 left-0 h-full w-3/4 border-r data-[state=closed]:slide-out-to-left data-[state=open]:slide-in-from-left sm:max-w-sm",right:"inset-y-0 right-0 h-full w-3/4  border-l data-[state=closed]:slide-out-to-right data-[state=open]:slide-in-from-right sm:max-w-sm"}},defaultVariants:{side:"right"}}),Y=M.forwardRef((e,s)=>{var a=e,{side:t="right",className:l,children:r}=a,n=d(a,["side","className","children"]);return x.jsxs(B,{children:[x.jsx(K,{}),x.jsxs(p,c(i({ref:s,className:j(W({side:t}),l)},n),{children:[r,x.jsxs(g,{className:"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-secondary",children:[x.jsx(u,{className:"h-4 w-4"}),x.jsx("span",{className:"sr-only",children:"Close"})]})]}))]})});Y.displayName=p.displayName;const Z=e=>{var s=e,{className:a}=s,t=d(s,["className"]);return x.jsx("div",i({className:j("flex flex-col space-y-2 text-center sm:text-left",a)},t))};Z.displayName="SheetHeader";const G=M.forwardRef((e,s)=>{var a=e,{className:t}=a,l=d(a,["className"]);return x.jsx(N,i({ref:s,className:j("text-lg font-semibold text-foreground",t)},l))});G.displayName=N.displayName;M.forwardRef((e,s)=>{var a=e,{className:t}=a,l=d(a,["className"]);return x.jsx(b,i({ref:s,className:j("text-sm text-muted-foreground",t)},l))}).displayName=b.displayName;function Q(){var e;const{user:s}=v(),[a,t]=M.useState([]),[l,r]=M.useState(!1),[n,i]=M.useState(0),[c,d]=M.useState(0),[o,m]=M.useState(""),[h,p]=M.useState("ALL"),[j,g]=M.useState("ALL"),[u,f]=M.useState(""),[N,y]=M.useState(""),[b,B]=M.useState(null),K="OWNER"===(null==(e=null==s?void 0:s.role)?void 0:e.toUpperCase()),W=(e=!1)=>{return s=this,l=null,i=function*(){if(K){r(!0);try{const s=e?0:50*n,l=s+50-1;let r=$.from("audit_log").select("*",{count:"exact"}).order("at",{ascending:!1}).range(s,l);if("ALL"!==h&&(r=r.eq("action",h)),"ALL"!==j&&(r=r.eq("table_name",j)),u&&(r=r.gte("at",new Date(u).toISOString())),N){const e=new Date(N);e.setHours(23,59,59,999),r=r.lte("at",e.toISOString())}o.trim()&&(r=r.or(`actor_email.ilike.%${o}%,row_pk.ilike.%${o}%,request_id.ilike.%${o}%`));const{data:i,error:c,count:m}=yield r;if(c)throw c;t(e?i:[...a,...i]),e&&d(m||0)}catch(s){}finally{r(!1)}}},new Promise((e,a)=>{var t=e=>{try{n(i.next(e))}catch(s){a(s)}},r=e=>{try{n(i.throw(e))}catch(s){a(s)}},n=s=>s.done?e(s.value):Promise.resolve(s.value).then(t,r);n((i=i.apply(s,l)).next())});var s,l,i};M.useEffect(()=>{i(0),W(!0)},[h,j,u,N]),M.useEffect(()=>{n>0&&W(!1)},[n]);const Q=M.useMemo(()=>{const e=new Set(a.map(e=>e.table_name));return["ALL",...Array.from(e).sort()]},[a]),X=e=>{switch(e){case"INSERT":return"bg-green-100 text-green-800 hover:bg-green-200";case"UPDATE":return"bg-yellow-100 text-yellow-800 hover:bg-yellow-200";case"DELETE":return"bg-red-100 text-red-800 hover:bg-red-200";default:return"bg-gray-100 text-gray-800"}},ee=e=>{switch(e){case"INSERT":return"âž•";case"UPDATE":return"âœï¸";case"DELETE":return"ðŸ—‘ï¸";default:return"â“"}};return K?x.jsxs("div",{className:"p-4 md:p-6 space-y-6",children:[x.jsxs("div",{className:"flex items-center justify-between",children:[x.jsxs("div",{className:"flex items-center gap-3",children:[x.jsx("div",{className:"p-2 bg-blue-100 rounded-lg",children:x.jsx(_,{className:"h-6 w-6 text-blue-600"})}),x.jsxs("div",{children:[x.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"System Audit Log"}),x.jsx("p",{className:"text-gray-600",children:"Complete database change tracking"})]})]}),x.jsxs("div",{className:"flex items-center gap-2",children:[x.jsxs(S,{variant:"outline",className:"bg-blue-50 text-blue-700",children:[c.toLocaleString()," total entries"]}),x.jsxs(A,{variant:"outline",onClick:()=>{const e=[["timestamp","actor_email","action","schema_name","table_name","row_pk","changed_fields"].join(","),...a.map(e=>{var s,a;return[e.at,null!=(s=e.actor_email)?s:"",e.action,e.schema_name,e.table_name,e.row_pk,(null!=(a=e.changed_fields)?a:[]).join("|")].map(e=>`"${String(e).replaceAll('"','""')}"`).join(",")})].join("\n"),s=new Blob([e],{type:"text/csv;charset=utf-8;"}),t=URL.createObjectURL(s),l=document.createElement("a");l.href=t,l.download=`monza_audit_log_${V(new Date,"yyyyMMdd_HHmmss")}.csv`,l.click(),URL.revokeObjectURL(t)},disabled:0===a.length,children:[x.jsx(F,{className:"w-4 h-4 mr-2"}),"Export CSV"]})]})]}),x.jsxs(E,{children:[x.jsx(D,{children:x.jsxs(k,{className:"text-base flex items-center gap-2",children:[x.jsx(L,{className:"h-4 w-4"}),"Filters & Search"]})}),x.jsxs(C,{className:"space-y-4",children:[x.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-5 gap-4",children:[x.jsxs("div",{className:"col-span-2",children:[x.jsx("label",{className:"text-sm font-medium mb-1 block",children:"Search"}),x.jsx(R,{placeholder:"Search email, row ID, or request ID...",value:o,onChange:e=>m(e.target.value),onKeyDown:e=>"Enter"===e.key&&(i(0),W(!0))})]}),x.jsxs("div",{children:[x.jsx("label",{className:"text-sm font-medium mb-1 block",children:"Action"}),x.jsxs(T,{value:h,onValueChange:e=>p(e),children:[x.jsx(O,{children:x.jsx(I,{placeholder:"All actions"})}),x.jsxs(P,{children:[x.jsx(U,{value:"ALL",children:"All actions"}),x.jsx(U,{value:"INSERT",children:"âž• INSERT"}),x.jsx(U,{value:"UPDATE",children:"âœï¸ UPDATE"}),x.jsx(U,{value:"DELETE",children:"ðŸ—‘ï¸ DELETE"})]})]})]}),x.jsxs("div",{className:"audit-dropdown-container",children:[x.jsx("label",{className:"text-sm font-medium mb-1 block",children:"Table"}),x.jsxs(T,{value:j,onValueChange:e=>g(e),children:[x.jsx(O,{children:x.jsx(I,{placeholder:"All tables"})}),x.jsx(P,{position:"popper",side:"bottom",align:"start",sideOffset:4,avoidCollisions:!0,className:"select-content-fixed",children:Q.map(e=>x.jsx(U,{value:e,children:"ALL"===e?"All tables":e},e))})]})]}),x.jsxs("div",{children:[x.jsx("label",{className:"text-sm font-medium mb-1 block",children:"Date Range"}),x.jsxs("div",{className:"flex gap-2",children:[x.jsx(R,{type:"date",value:u,onChange:e=>f(e.target.value),className:"text-sm flex-1 min-w-0",placeholder:"From date"}),x.jsx(R,{type:"date",value:N,onChange:e=>y(e.target.value),className:"text-sm flex-1 min-w-0",placeholder:"To date"})]})]})]}),x.jsx("div",{className:"flex justify-end",children:x.jsx(A,{onClick:()=>{i(0),W(!0)},children:"Apply Filters"})})]})]}),x.jsx(E,{children:x.jsxs(C,{className:"p-0",children:[x.jsx("div",{className:"w-full overflow-auto",children:x.jsxs("table",{className:"w-full text-sm",children:[x.jsx("thead",{className:"sticky top-0 bg-gray-50 border-b",children:x.jsxs("tr",{className:"text-left",children:[x.jsx("th",{className:"px-4 py-3 font-medium text-gray-900",children:x.jsxs("div",{className:"flex items-center gap-1",children:[x.jsx(q,{className:"h-4 w-4"}),"Time"]})}),x.jsx("th",{className:"px-4 py-3 font-medium text-gray-900",children:"Actor"}),x.jsx("th",{className:"px-4 py-3 font-medium text-gray-900",children:"Action"}),x.jsx("th",{className:"px-4 py-3 font-medium text-gray-900",children:"Table"}),x.jsx("th",{className:"px-4 py-3 font-medium text-gray-900",children:"Row ID"}),x.jsx("th",{className:"px-4 py-3 font-medium text-gray-900",children:"Changed Fields"}),x.jsx("th",{className:"px-4 py-3 font-medium text-gray-900 text-center",children:"Details"})]})}),x.jsxs("tbody",{children:[a.map(e=>x.jsxs("tr",{className:"border-b hover:bg-gray-50 transition-colors",children:[x.jsxs("td",{className:"px-4 py-3 whitespace-nowrap text-gray-700",children:[V(new Date(e.at),"MMM d, yyyy"),x.jsx("br",{}),x.jsx("span",{className:"text-xs text-gray-500",children:V(new Date(e.at),"HH:mm:ss")})]}),x.jsxs("td",{className:"px-4 py-3",children:[x.jsx("div",{className:"text-gray-900 font-medium",children:e.actor_email||"System"}),e.actor_id&&x.jsxs("div",{className:"text-xs text-gray-500 font-mono",children:[e.actor_id.substring(0,8),"..."]})]}),x.jsx("td",{className:"px-4 py-3",children:x.jsxs(S,{className:X(e.action),children:[ee(e.action)," ",e.action]})}),x.jsxs("td",{className:"px-4 py-3",children:[x.jsx("div",{className:"font-medium text-gray-900",children:e.table_name}),x.jsx("div",{className:"text-xs text-gray-500",children:e.schema_name})]}),x.jsx("td",{className:"px-4 py-3 font-mono text-sm",children:e.row_pk}),x.jsx("td",{className:"px-4 py-3",children:e.changed_fields&&e.changed_fields.length>0?x.jsxs("div",{className:"flex flex-wrap gap-1",children:[e.changed_fields.slice(0,3).map((e,s)=>x.jsx(S,{variant:"secondary",className:"text-xs",children:e},s)),e.changed_fields.length>3&&x.jsxs(S,{variant:"secondary",className:"text-xs",children:["+",e.changed_fields.length-3," more"]})]}):x.jsx("span",{className:"text-gray-400",children:"â€”"})}),x.jsx("td",{className:"px-4 py-3 text-center",children:x.jsxs(z,{children:[x.jsx(J,{asChild:!0,children:x.jsx(A,{variant:"ghost",size:"sm",onClick:()=>B(e),className:"h-8 w-8 p-0",children:x.jsx(H,{className:"w-4 h-4"})})}),x.jsxs(Y,{className:"w-full sm:max-w-4xl overflow-y-auto",children:[x.jsx(Z,{children:x.jsxs(G,{className:"flex items-center gap-2",children:[x.jsx(_,{className:"h-5 w-5"}),"Audit Entry Details"]})}),b&&x.jsxs("div",{className:"space-y-6 mt-6",children:[x.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[x.jsxs("div",{children:[x.jsx("span",{className:"font-semibold text-gray-700",children:"Timestamp:"}),x.jsx("div",{className:"text-gray-900",children:V(new Date(b.at),"PPP 'at' HH:mm:ss")})]}),x.jsxs("div",{children:[x.jsx("span",{className:"font-semibold text-gray-700",children:"Actor:"}),x.jsxs("div",{className:"text-gray-900",children:[b.actor_email||"System",b.actor_id&&x.jsxs("div",{className:"text-xs text-gray-500 font-mono",children:["ID: ",b.actor_id]})]})]}),x.jsxs("div",{children:[x.jsx("span",{className:"font-semibold text-gray-700",children:"Action:"}),x.jsx("div",{children:x.jsxs(S,{className:X(b.action),children:[ee(b.action)," ",b.action]})})]}),x.jsxs("div",{children:[x.jsx("span",{className:"font-semibold text-gray-700",children:"Table:"}),x.jsxs("div",{className:"text-gray-900",children:[b.schema_name,".",b.table_name,x.jsxs("div",{className:"text-xs text-gray-500",children:["Row ID: ",b.row_pk]})]})]}),b.request_ip&&x.jsxs("div",{children:[x.jsx("span",{className:"font-semibold text-gray-700",children:"IP Address:"}),x.jsx("div",{className:"text-gray-900 font-mono",children:b.request_ip})]}),b.request_id&&x.jsxs("div",{children:[x.jsx("span",{className:"font-semibold text-gray-700",children:"Request ID:"}),x.jsx("div",{className:"text-gray-900 font-mono",children:b.request_id})]})]}),b.changed_fields&&b.changed_fields.length>0&&x.jsxs("div",{children:[x.jsx("span",{className:"font-semibold text-gray-700 block mb-2",children:"Changed Fields:"}),x.jsx("div",{className:"flex flex-wrap gap-2",children:b.changed_fields.map((e,s)=>x.jsx(S,{variant:"secondary",children:e},s))})]}),x.jsxs("div",{className:"space-y-4",children:[x.jsx("h3",{className:"font-semibold text-gray-700",children:"Data Changes"}),x.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-4",children:[x.jsxs("div",{children:[x.jsxs("h4",{className:"text-sm font-medium text-gray-600 mb-2",children:["Before ","INSERT"===b.action?"(New Record)":""]}),x.jsx("pre",{className:"p-4 bg-red-50 border border-red-200 rounded-lg text-xs overflow-auto max-h-96",children:b.before_data?JSON.stringify(b.before_data,null,2):"N/A (New record)"})]}),x.jsxs("div",{children:[x.jsxs("h4",{className:"text-sm font-medium text-gray-600 mb-2",children:["After ","DELETE"===b.action?"(Deleted)":""]}),x.jsx("pre",{className:"p-4 bg-green-50 border border-green-200 rounded-lg text-xs overflow-auto max-h-96",children:b.after_data?JSON.stringify(b.after_data,null,2):"N/A (Record deleted)"})]})]})]}),b.app_context&&x.jsxs("div",{children:[x.jsx("span",{className:"font-semibold text-gray-700 block mb-2",children:"Application Context:"}),x.jsx("pre",{className:"p-4 bg-blue-50 border border-blue-200 rounded-lg text-xs overflow-auto",children:JSON.stringify(b.app_context,null,2)})]})]})]})]})})]},e.id)),!l&&0===a.length&&x.jsx("tr",{children:x.jsxs("td",{colSpan:7,className:"px-4 py-12 text-center text-gray-500",children:[x.jsx(_,{className:"h-12 w-12 text-gray-300 mx-auto mb-4"}),x.jsx("div",{className:"text-lg font-medium mb-1",children:"No audit entries found"}),x.jsx("div",{className:"text-sm",children:"Try adjusting your filters or date range"})]})})]})]})}),a.length>0&&x.jsx("div",{className:"p-4 border-t bg-gray-50 flex justify-center",children:x.jsx(A,{variant:"outline",disabled:l||a.length>=c,onClick:()=>i(e=>e+1),children:l?"Loading...":a.length>=c?"All entries loaded":`Load more (${a.length} of ${c.toLocaleString()})`})})]})})]}):x.jsx("div",{className:"container mx-auto p-6",children:x.jsxs("div",{className:"text-center py-12",children:[x.jsx(w,{className:"h-16 w-16 text-gray-400 mx-auto mb-4"}),x.jsx("h2",{className:"text-2xl font-bold text-gray-600 mb-2",children:"Access Restricted"}),x.jsx("p",{className:"text-gray-500 mb-4",children:"System audit logs are only accessible to owners."}),x.jsxs("p",{className:"text-sm text-gray-400",children:["Current user: ",(null==s?void 0:s.name)||"Unknown"," (",(null==s?void 0:s.role)||"No role",")"]})]})})}export{Q as default};
