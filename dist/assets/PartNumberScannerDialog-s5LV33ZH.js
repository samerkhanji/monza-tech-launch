var e=Object.defineProperty,t=Object.getOwnPropertySymbols,a=Object.prototype.hasOwnProperty,r=Object.prototype.propertyIsEnumerable,n=(t,a,r)=>a in t?e(t,a,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[a]=r,s=(e,s)=>{for(var i in s||(s={}))a.call(s,i)&&n(e,i,s[i]);if(t)for(var i of t(s))r.call(s,i)&&n(e,i,s[i]);return e},i=(e,t,a)=>new Promise((r,n)=>{var s=e=>{try{l(a.next(e))}catch(t){n(t)}},i=e=>{try{l(a.throw(e))}catch(t){n(t)}},l=e=>e.done?r(e.value):Promise.resolve(e.value).then(s,i);l((a=a.apply(e,t)).next())});import{a8 as l,s as c,l as o,K as d,j as m,y as u,as as h,k as p,z as x,E as b,F as y,ah as v,X as f,L as g,I as j,a4 as N}from"./index-BmUpYGrm.js";import{r as w}from"./vendor-vN6PtkFd.js";import{e as k}from"./enhancedMonzaBotService-CP3UVEVb.js";import{L as P}from"./loader-2-BYW_3amd.js";import{C}from"./camera-CKQtJJJ8.js";
/**
 * @license lucide-react v0.309.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const E=l("ScanLine",[["path",{d:"M3 7V5a2 2 0 0 1 2-2h2",key:"aa7l1z"}],["path",{d:"M17 3h2a2 2 0 0 1 2 2v2",key:"4qcy5o"}],["path",{d:"M21 17v2a2 2 0 0 1-2 2h-2",key:"6vwrx8"}],["path",{d:"M7 21H5a2 2 0 0 1-2-2v-2",key:"ioqczr"}],["path",{d:"M7 12h10",key:"b7w52i"}]]),S=e=>i(void 0,null,function*(){try{const t=yield k.processEnhancedMessage("Extract and return ONLY the part number from this image. Look for alphanumeric codes that could be part numbers. Return only the part number, nothing else.",{source:"part_number_extraction",imageData:e,currentRoute:"/scan-part"});return t.textResponse.trim().replace(/[^\w-]/g,"").substring(0,50)}catch(t){throw new Error("Failed to extract part number from image")}});const I=new class{trackEvent(e){return i(this,null,function*(){try{const{error:t}=yield c.from("user_activity_logs").insert({activity_type:e.eventType,user_name:e.userName,description:`${e.entityType}: ${e.entityId}`,user_id:e.userName||"unknown"})}catch(t){}})}trackVinScan(e){return i(this,null,function*(){yield this.trackEvent({eventType:"vin_scan",entityType:"vehicle",entityId:e.vinNumber,userName:e.scannedBy,metadata:{scanMethod:e.scanMethod,destination:e.carDestination}})})}trackPartScan(e){return i(this,null,function*(){yield this.trackEvent({eventType:"part_scan",entityType:"part",entityId:e.partNumber,userName:e.scannedBy,metadata:{scanMethod:e.scanMethod,photoUrl:e.photoUrl,ocrConfidence:e.ocrConfidence}})})}trackPartUsage(e){return i(this,null,function*(){yield this.trackEvent({eventType:"part_usage",entityType:"part",entityId:e.partNumber,userName:e.usedBy||e.technician||"Unknown",metadata:{partName:e.partName,quantity:e.quantity,carVin:e.carVin,carModel:e.carModel,clientName:e.clientName,clientPhone:e.clientPhone,clientLicensePlate:e.clientLicensePlate,repairId:e.repairId,costPerUnit:e.costPerUnit,totalCost:e.totalCost}})})}trackClientInteraction(e){return i(this,null,function*(){yield this.trackEvent({eventType:"client_interaction",entityType:"client",entityId:e.clientName,userName:e.handledBy||e.employee||"Unknown",metadata:{clientPhone:e.clientPhone,clientLicensePlate:e.clientLicensePlate,carVin:e.carVin,interactionType:e.interactionType,details:e.details||e.notes}})})}trackWorkflowEvent(e){return i(this,null,function*(){yield this.trackEvent({eventType:e.eventType,entityType:e.entityType,entityId:e.entityId,userName:e.userName,metadata:s({details:e.details},e.metadata)})})}trackPhoto(e,t,a,r,n,l){return i(this,null,function*(){yield this.trackEvent({eventType:"photo_capture",entityType:a,entityId:n,userName:r,metadata:s({photoUrl:e,context:t},l)})})}getWorkflowHistory(e,t){return i(this,null,function*(){try{let t=c.from("user_activity_logs").select("*").order("created_at",{ascending:!1});e&&(t=t.ilike("description",`${e}%`));const{data:a,error:r}=yield t;return r?[]:a||[]}catch(t){return[]}})}},M=({onPartNumberScanned:e,children:t})=>{const[a,r]=w.useState(!1),[n,s]=w.useState(!1),[l,c]=w.useState(!1),[k,M]=w.useState(null),[T,U]=w.useState(""),[O,R]=w.useState(""),[_,F]=w.useState(!1),[L,V]=w.useState(null),B=w.useRef(null),q=w.useRef(null),z=w.useRef(null),{toast:D}=o(),{user:$}=d(),H=()=>i(void 0,null,function*(){try{V(null);const e=yield navigator.mediaDevices.getUserMedia({video:{facingMode:"environment",width:{ideal:1280},height:{ideal:720}}});z.current=e,B.current&&(B.current.srcObject=e,B.current.onloadedmetadata=()=>{B.current&&B.current.play().then(()=>{s(!0),M(null),U(""),F(!1),D({title:"Camera ready",description:"Position the part number clearly in the target area and capture"})}).catch(e=>{V("Failed to play video stream")})},B.current.onerror=e=>{V("Video element error")})}catch(e){V(e instanceof Error?e.message:"Unknown camera error"),D({title:"Camera error",description:"Could not access camera. Please check permissions.",variant:"destructive"})}}),W=()=>{z.current&&(z.current.getTracks().forEach(e=>e.stop()),z.current=null),B.current&&(B.current.srcObject=null),s(!1),V(null)},Y=()=>{W(),M(null),U(""),R(""),F(!1),c(!1),V(null)},K=()=>{M(null),U(""),F(!1),H()};return w.useEffect(()=>()=>{W()},[]),m.jsxs(u,{open:a,onOpenChange:e=>{r(e),e||Y()},children:[m.jsx(h,{asChild:!0,children:t||m.jsx(p,{variant:"outline",size:"sm",children:m.jsx(E,{className:"h-4 w-4"})})}),m.jsxs(x,{className:"max-w-2xl max-h-[90vh] overflow-y-auto",children:[m.jsx(b,{children:m.jsxs(y,{className:"flex items-center gap-2",children:[m.jsx(E,{className:"h-5 w-5"}),"Scan Part Number"]})}),m.jsxs("div",{className:"space-y-4",children:[L&&m.jsx("div",{className:"p-3 bg-red-50 border border-red-200 rounded-lg",children:m.jsxs("p",{className:"text-sm text-red-600",children:["Camera Error: ",L]})}),m.jsxs("div",{className:"w-full aspect-video bg-slate-100 rounded-md overflow-hidden relative",children:[n&&!k?m.jsxs(m.Fragment,{children:[m.jsx("video",{ref:B,className:"w-full h-full object-cover",playsInline:!0,muted:!0,autoPlay:!0}),m.jsxs("div",{className:"absolute inset-0 pointer-events-none",children:[m.jsx("div",{className:"absolute inset-0 bg-black bg-opacity-40"}),m.jsx("div",{className:"absolute inset-0 flex items-center justify-center",children:m.jsxs("div",{className:"relative",children:[m.jsx("div",{className:"w-64 h-16 border-2 border-white border-dashed bg-transparent rounded-lg"}),m.jsx("div",{className:"absolute -top-2 -left-2 w-6 h-6 border-l-4 border-t-4 border-green-400 rounded-tl-lg"}),m.jsx("div",{className:"absolute -top-2 -right-2 w-6 h-6 border-r-4 border-t-4 border-green-400 rounded-tr-lg"}),m.jsx("div",{className:"absolute -bottom-2 -left-2 w-6 h-6 border-l-4 border-b-4 border-green-400 rounded-bl-lg"}),m.jsx("div",{className:"absolute -bottom-2 -right-2 w-6 h-6 border-r-4 border-b-4 border-green-400 rounded-br-lg"})]})}),m.jsx("div",{className:"absolute bottom-4 left-0 right-0 text-center",children:m.jsx("p",{className:"text-white text-sm font-medium bg-black bg-opacity-60 rounded-full px-4 py-2 mx-4",children:"Position part number in the target area"})}),m.jsxs("div",{className:"absolute top-2 left-2 bg-red-500 text-white px-2 py-1 rounded text-xs flex items-center gap-1",children:[m.jsx("div",{className:"w-2 h-2 bg-white rounded-full animate-pulse"}),"LIVE"]})]})]}):k?m.jsxs("div",{className:"relative w-full h-full",children:[m.jsx("img",{src:k,alt:"Captured part",className:"w-full h-full object-cover rounded-md"}),l&&m.jsx("div",{className:"absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center",children:m.jsxs("div",{className:"bg-white rounded-lg p-4 flex items-center gap-3",children:[m.jsx(P,{className:"h-5 w-5 animate-spin"}),m.jsx("span",{className:"text-sm font-medium",children:"Processing with OCR..."})]})})]}):m.jsxs("div",{className:"flex flex-col items-center justify-center h-full text-muted-foreground",children:[m.jsx(C,{className:"h-16 w-16 mb-2 opacity-30"}),m.jsx("p",{className:"text-sm",children:'Click "Start Camera" to begin scanning'}),m.jsx("p",{className:"text-xs mt-1",children:"Position part number clearly for best results"})]}),m.jsx("canvas",{ref:q,className:"hidden"})]}),T&&m.jsxs("div",{className:"bg-green-50 border border-green-200 rounded-lg p-4",children:[m.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[m.jsx(v,{className:"h-4 w-4 text-green-600"}),m.jsx("span",{className:"text-sm font-medium text-green-700",children:"Part Number Detected"})]}),m.jsx("div",{className:"bg-white rounded px-3 py-2 border",children:m.jsx("span",{className:"font-mono font-semibold text-lg",children:T})})]}),_&&m.jsxs("div",{className:"bg-amber-50 border border-amber-200 rounded-lg p-4",children:[m.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[m.jsx(f,{className:"h-4 w-4 text-amber-600"}),m.jsx("span",{className:"text-sm font-medium text-amber-700",children:"Manual Entry Required"})]}),m.jsxs("div",{className:"space-y-2",children:[m.jsx(g,{htmlFor:"manualPartNumber",className:"text-sm",children:"Enter Part Number:"}),m.jsx(j,{id:"manualPartNumber",value:O,onChange:e=>R(e.target.value),placeholder:"Enter part number manually...",className:"font-mono"})]})]}),m.jsxs("div",{className:"flex gap-2",children:[!n&&!k&&m.jsxs(p,{onClick:H,className:"flex-1",disabled:l,children:[m.jsx(C,{className:"mr-2 h-4 w-4"}),"Start Camera"]}),n&&!k&&m.jsxs(m.Fragment,{children:[m.jsx(p,{onClick:W,variant:"outline",className:"flex-1",children:"Cancel"}),m.jsxs(p,{onClick:()=>{if(B.current&&q.current&&z.current)try{const e=B.current,t=q.current,a=t.getContext("2d");if(!a)return;t.width=e.videoWidth,t.height=e.videoHeight,a.drawImage(e,0,0,t.width,t.height);const r=t.toDataURL("image/jpeg",.9);M(r),W(),D({title:"Image captured",description:"Image captured successfully. Click 'Process with OCR' to extract part number."})}catch(e){D({title:"Capture failed",description:"Failed to capture image. Please try again.",variant:"destructive"})}},className:"flex-1",disabled:!z.current,children:[m.jsx(C,{className:"mr-2 h-4 w-4"}),"Capture Image"]})]}),k&&!T&&!_&&m.jsxs(m.Fragment,{children:[m.jsxs(p,{onClick:K,variant:"outline",className:"flex-1",disabled:l,children:[m.jsx(N,{className:"mr-2 h-4 w-4"}),"Retake"]}),m.jsx(p,{onClick:()=>i(void 0,null,function*(){if(k){c(!0);try{const e=yield S(k);e&&e.trim()?(U(e),yield I.trackPartScan({partNumber:e,scanMethod:"camera",scannedBy:(null==$?void 0:$.name)||"Unknown User",photoUrl:k,ocrConfidence:.8}),yield I.trackPhoto(k,"part_scan",e,(null==$?void 0:$.name)||"Unknown User",e,{ocrProcessed:!0}),D({title:"Part number detected",description:`Extracted: ${e}`})):(U(""),F(!0),D({title:"No part number detected",description:"Please enter the part number manually or try again.",variant:"destructive"}))}catch(e){U(""),F(!0),D({title:"OCR failed",description:"Failed to process image. Please enter part number manually.",variant:"destructive"})}finally{c(!1)}}}),disabled:l,className:"flex-1",children:l?m.jsxs(m.Fragment,{children:[m.jsx(P,{className:"mr-2 h-4 w-4 animate-spin"}),"Processing..."]}):m.jsxs(m.Fragment,{children:[m.jsx(E,{className:"mr-2 h-4 w-4"}),"Process with OCR"]})})]}),(T||_&&O)&&m.jsxs(m.Fragment,{children:[m.jsxs(p,{onClick:K,variant:"outline",className:"flex-1",children:[m.jsx(N,{className:"mr-2 h-4 w-4"}),"Retake Photo"]}),m.jsxs(p,{onClick:()=>i(void 0,null,function*(){const t=T||O;t.trim()?(O&&!T&&(yield I.trackPartScan({partNumber:t.trim(),scanMethod:"manual",scannedBy:(null==$?void 0:$.name)||"Unknown User"})),e(t.trim()),r(!1),Y(),D({title:"Part number confirmed",description:`Part number ${t} has been added`})):D({title:"No part number",description:"Please enter a part number or scan again.",variant:"destructive"})}),className:"flex-1",children:[m.jsx(v,{className:"mr-2 h-4 w-4"}),"Use Part Number"]})]})]}),m.jsxs("div",{className:"text-xs text-muted-foreground text-center space-y-1",children:[m.jsx("p",{children:"• Position the part number clearly within the target area"}),m.jsx("p",{children:"• Ensure good lighting and focus for best OCR results"}),m.jsx("p",{children:"• You can manually enter the part number if OCR fails"})]})]})]})]})};export{M as P,E as S,S as e,I as w};
