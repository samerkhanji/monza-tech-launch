var e=Object.defineProperty,t=Object.defineProperties,n=Object.getOwnPropertyDescriptors,l=Object.getOwnPropertySymbols,i=Object.prototype.hasOwnProperty,r=Object.prototype.propertyIsEnumerable,a=(t,n,l)=>n in t?e(t,n,{enumerable:!0,configurable:!0,writable:!0,value:l}):t[n]=l,o=(e,t)=>{for(var n in t||(t={}))i.call(t,n)&&a(e,n,t[n]);if(l)for(var n of l(t))r.call(t,n)&&a(e,n,t[n]);return e},s=(e,t,n)=>a(e,"symbol"!=typeof t?t+"":t,n);const c=new class{constructor(){s(this,"STORAGE_KEY","carClientLinks"),s(this,"INTEGRITY_LOG_KEY","carDataIntegrityLog")}getAllLinks(){try{const e=localStorage.getItem(this.STORAGE_KEY);return e?JSON.parse(e):[]}catch(e){return[]}}linkCarWithClient(e,l,i,r="system"){const a=(new Date).toISOString(),s=Boolean(l.vinNumber&&l.vinNumber.length>=10),c=Boolean(i.clientName&&i.clientPhone),d=Boolean(i.saleDate||i.reservationDate||i.deliveryDate),u=s&&c&&d,g={carId:e,vinNumber:l.vinNumber,model:l.model,brand:l.brand,year:l.year,color:l.color,status:l.status,location:l.location,clientInfo:(I=o({},i),v={saleDate:i.saleDate||("sold"===l.status?a:void 0),reservationDate:i.reservationDate||("reserved"===l.status?a:void 0)},t(I,n(v))),lastUpdated:a,dataIntegrityLog:{recordedAt:a,recordedBy:r,vinVerified:s,clientVerified:c,dateTimeRecorded:d,allDataPresent:u}};var I,v;const f=this.getAllLinks(),h=f.findIndex(t=>t.carId===e);h>=0?f[h]=g:f.push(g),localStorage.setItem(this.STORAGE_KEY,JSON.stringify(f)),this.logDataIntegrity(g),this.syncToCarSources(g)}unlinkCar(e){const t=this.getAllLinks().filter(t=>t.carId!==e);localStorage.setItem(this.STORAGE_KEY,JSON.stringify(t)),this.updateCarInAllSources(e,{status:"in_stock",clientName:"",clientPhone:"",clientEmail:"",clientAddress:"",clientLicensePlate:"",sellingPrice:0,saleDate:"",reservationDate:"",deliveryDate:"",notes:""})}getClientForCar(e){const t=this.getAllLinks().find(t=>t.carId===e);return(null==t?void 0:t.clientInfo)||null}getCarsForClient(e){return this.getAllLinks().filter(t=>{var n,l,i;return(null==(n=t.clientInfo)?void 0:n.clientPhone)===e||(null==(i=null==(l=t.clientInfo)?void 0:l.clientName)?void 0:i.toLowerCase().includes(e.toLowerCase()))})}updateClientInfo(e,t){const n=this.getAllLinks(),l=n.findIndex(t=>t.carId===e);-1!==l&&(n[l].clientInfo=o(o({},n[l].clientInfo),t),n[l].lastUpdated=(new Date).toISOString(),localStorage.setItem(this.STORAGE_KEY,JSON.stringify(n)),this.syncWithCarSources(e,n[l]))}syncWithCarSources(e,t){["carInventory","showroomFloor1Cars","showroomFloor2Cars","garageCars"].forEach(n=>{var l,i,r,a,o,s,c,d,u,g;this.updateCarInSource(n,e,{status:t.status,clientName:(null==(l=t.clientInfo)?void 0:l.clientName)||"",clientPhone:(null==(i=t.clientInfo)?void 0:i.clientPhone)||"",clientEmail:(null==(r=t.clientInfo)?void 0:r.clientEmail)||"",clientAddress:(null==(a=t.clientInfo)?void 0:a.clientAddress)||"",clientLicensePlate:(null==(o=t.clientInfo)?void 0:o.clientLicensePlate)||"",sellingPrice:(null==(s=t.clientInfo)?void 0:s.sellingPrice)||0,saleDate:(null==(c=t.clientInfo)?void 0:c.saleDate)||"",reservationDate:(null==(d=t.clientInfo)?void 0:d.reservationDate)||"",deliveryDate:(null==(u=t.clientInfo)?void 0:u.deliveryDate)||"",notes:(null==(g=t.clientInfo)?void 0:g.notes)||"",lastUpdated:t.lastUpdated})})}updateCarInSource(e,t,n){try{const l=localStorage.getItem(e);if(l){const i=JSON.parse(l),r=i.findIndex(e=>e.id===t);-1!==r&&(i[r]=o(o({},i[r]),n),localStorage.setItem(e,JSON.stringify(i)))}}catch(l){}}updateCarInAllSources(e,t){["carInventory","showroomFloor1Cars","showroomFloor2Cars","garageCars"].forEach(n=>{this.updateCarInSource(n,e,t)})}initializeFromExistingData(){const e=this.getAllLinks(),t=[...e];["carInventory","showroomFloor1Cars","showroomFloor2Cars","garageCars"].forEach(n=>{const l=localStorage.getItem(n);if(l){JSON.parse(l).forEach(l=>{if(("reserved"===l.status||"sold"===l.status)&&l.clientName){if(!e.find(e=>e.carId===l.id)){const e={carId:l.id,vinNumber:l.vinNumber,model:l.model,brand:l.brand,year:l.year,color:l.color,status:l.status,location:l.location||n.replace("Cars","").replace(/([A-Z])/g," $1").trim(),clientInfo:{clientName:l.clientName,clientPhone:l.clientPhone,clientEmail:l.clientEmail,clientAddress:l.clientAddress,clientLicensePlate:l.clientLicensePlate,sellingPrice:l.sellingPrice,saleDate:l.saleDate,reservationDate:l.reservationDate||l.reservedDate,deliveryDate:l.deliveryDate,notes:l.notes},lastUpdated:l.lastUpdated||(new Date).toISOString()};t.push(e)}}})}}),localStorage.setItem(this.STORAGE_KEY,JSON.stringify(t))}searchLinks(e){const t=this.getAllLinks(),n=e.toLowerCase();return t.filter(t=>{var l,i;return t.vinNumber.toLowerCase().includes(n)||t.model.toLowerCase().includes(n)||t.brand&&t.brand.toLowerCase().includes(n)||(null==(l=t.clientInfo)?void 0:l.clientName)&&t.clientInfo.clientName.toLowerCase().includes(n)||(null==(i=t.clientInfo)?void 0:i.clientPhone)&&t.clientInfo.clientPhone.includes(e)})}getDeliveryStats(){const e=this.getAllLinks(),t=new Date;return{totalReserved:e.filter(e=>"reserved"===e.status).length,totalSold:e.filter(e=>"sold"===e.status).length,pendingDelivery:e.filter(e=>{var t;return("reserved"===e.status||"sold"===e.status)&&(null==(t=e.clientInfo)?void 0:t.deliveryDate)}).length,overdueDelivery:e.filter(e=>{var n;return(null==(n=e.clientInfo)?void 0:n.deliveryDate)&&new Date(e.clientInfo.deliveryDate)<t}).length}}logDataIntegrity(e){const t=JSON.parse(localStorage.getItem(this.INTEGRITY_LOG_KEY)||"[]"),n={id:crypto.randomUUID(),vinNumber:e.vinNumber,clientName:e.clientInfo.clientName,status:e.status,timestamp:(new Date).toISOString(),integrity:e.dataIntegrityLog,dataSnapshot:{hasVin:Boolean(e.vinNumber),hasClient:Boolean(e.clientInfo.clientName),hasPhone:Boolean(e.clientInfo.clientPhone),hasDateTime:Boolean(e.clientInfo.saleDate||e.clientInfo.reservationDate),hasPrice:Boolean(e.clientInfo.sellingPrice)}};t.push(n),localStorage.setItem(this.INTEGRITY_LOG_KEY,JSON.stringify(t))}syncToCarSources(e){const t={status:e.status,clientName:e.clientInfo.clientName,clientPhone:e.clientInfo.clientPhone,clientEmail:e.clientInfo.clientEmail||"",clientAddress:e.clientInfo.clientAddress||"",clientLicensePlate:e.clientInfo.clientLicensePlate||"",sellingPrice:e.clientInfo.sellingPrice||0,saleDate:e.clientInfo.saleDate,reservationDate:e.clientInfo.reservationDate,deliveryDate:e.clientInfo.deliveryDate,notes:e.clientInfo.notes||"",lastUpdated:e.lastUpdated};["carInventory","showroomFloor1Cars","showroomFloor2Cars","garageCars","garageCarInventory"].forEach(n=>{const l=localStorage.getItem(n);if(l){const i=JSON.parse(l),r=i.findIndex(t=>t.id===e.carId||t.vinNumber===e.vinNumber);r>=0&&(i[r]=o(o({},i[r]),t),localStorage.setItem(n,JSON.stringify(i)))}})}getDataIntegrityReport(){const e=JSON.parse(localStorage.getItem(this.INTEGRITY_LOG_KEY)||"[]"),t=this.getAllLinks();return{totalRecords:t.length,completeRecords:t.filter(e=>{var t;return null==(t=e.dataIntegrityLog)?void 0:t.allDataPresent}).length,incompleteRecords:t.filter(e=>{var t;return!(null==(t=e.dataIntegrityLog)?void 0:t.allDataPresent)}).length,recentLogs:e.slice(-10),summary:{withVin:t.filter(e=>{var t;return null==(t=e.dataIntegrityLog)?void 0:t.vinVerified}).length,withClient:t.filter(e=>{var t;return null==(t=e.dataIntegrityLog)?void 0:t.clientVerified}).length,withDateTime:t.filter(e=>{var t;return null==(t=e.dataIntegrityLog)?void 0:t.dateTimeRecorded}).length}}}};export{c};
