var e=(e,r,t)=>new Promise((n,o)=>{var a=e=>{try{i(t.next(e))}catch(r){o(r)}},s=e=>{try{i(t.throw(e))}catch(r){o(r)}},i=e=>e.done?n(e.value):Promise.resolve(e.value).then(a,s);i((t=t.apply(e,r)).next())});import{aS as r,j as t,s as n,k as o,ag as a}from"./index-BmUpYGrm.js";import{r as s,a as i}from"./vendor-vN6PtkFd.js";import{u as l}from"./index-DNyRc51V.js";import{M as d}from"./StandardWarrantyButton-EBT9bBYI.js";const c={CAR_INVENTORY:"Car Inventory",SHOWROOM_1:"Showroom • Floor 1",SHOWROOM_2:"Showroom • Floor 2",GARAGE_INVENTORY:"Garage Inventory",SCHEDULE:"Schedule"};function u({carId:o,currentFloor:a,tableContext:i}){const d=r(),[u,m]=s.useState(null),v=function(e){switch(e){case"FLOOR_1":return["SHOWROOM_2","CAR_INVENTORY","GARAGE_INVENTORY","SCHEDULE"];case"FLOOR_2":return["SHOWROOM_1","CAR_INVENTORY","GARAGE_INVENTORY","SCHEDULE"];case"CAR_INVENTORY":return["SHOWROOM_1","SHOWROOM_2","GARAGE_INVENTORY","SCHEDULE"];case"GARAGE_INVENTORY":return["SHOWROOM_1","SHOWROOM_2","CAR_INVENTORY","SCHEDULE"];case"SCHEDULE":return["SHOWROOM_1","SHOWROOM_2","CAR_INVENTORY","GARAGE_INVENTORY"];default:return[]}}(i).filter(e=>e!==a);return v.length?t.jsx(t.Fragment,{children:v.map(r=>t.jsx("div",{className:"px-3 py-2 text-sm cursor-pointer hover:bg-accent",onClick:()=>e(this,null,function*(){var t;try{m(r);yield function(r,t){return e(this,null,function*(){const{data:e,error:o}=yield n.from("car_inventory").update({current_floor:t,updated_at:(new Date).toISOString()}).eq("id",r).select().single();if(o)throw o;return e})}(o,r);[a,r].forEach(e=>{d.invalidateQueries({queryKey:["cars-by-floor",e]}),d.invalidateQueries({queryKey:["cars",e]}),d.invalidateQueries({queryKey:["car-inventory"]}),d.invalidateQueries({queryKey:["showroom-cars"]}),d.invalidateQueries({queryKey:["garage-cars"]}),d.invalidateQueries({queryKey:["cleanMoveCarService",e]})}),d.invalidateQueries({queryKey:["cars"]}),d.invalidateQueries({queryKey:["cleanMoveCarService"]}),setTimeout(()=>{window.location.reload()},300),l.success(`Moved → ${c[r]}`)}catch(s){l.error(null!=(t=null==s?void 0:s.message)?t:"Move failed")}finally{m(null)}}),children:u===r?"Moving…":c[r]},r))}):t.jsx("div",{className:"px-3 py-2 text-sm text-muted-foreground",children:"No valid destinations"})}const m=["SHOWROOM_1","SHOWROOM_2","CAR_INVENTORY","GARAGE_INVENTORY","SCHEDULE"];function v({orderedId:o}){const a=r(),[i,d]=s.useState(null);return t.jsx(t.Fragment,{children:m.map(r=>t.jsx("div",{className:"px-3 py-2 text-sm cursor-pointer hover:bg-accent",onClick:()=>e(this,null,function*(){var t;try{d(r),yield function(r,t){return e(this,null,function*(){const{data:e,error:o}=yield n.rpc("receive_ordered_car",{p_ordered_id:r,p_to:t});if(o)throw o;return e})}(o,r),["SHOWROOM_1","SHOWROOM_2","CAR_INVENTORY","GARAGE_INVENTORY","SCHEDULE"].forEach(e=>a.invalidateQueries({queryKey:["cars-by-floor",e]})),a.invalidateQueries({queryKey:["ordered-cars"]}),l.success(`Moved → ${c[r]}`)}catch(s){l.error(null!=(t=null==s?void 0:s.message)?t:"Move failed")}finally{d(null)}}),children:i===r?"Moving…":c[r]},r))})}const x=({options:e,onAction:r,className:n="",disabled:l=!1,ariaLabel:c="Actions",id:m,variant:x="button",size:h="sm"})=>{var p;const O=s.useRef(null),y=s.useRef(null),[E,R]=s.useState(!1),[N,f]=s.useState({top:0,right:0}),g=e.reduce((e,r)=>{const t=r.group||"main";return e[t]||(e[t]=[]),e[t].push(r),e},{});s.useEffect(()=>{if(E&&O.current){const e=setTimeout(()=>{if(y.current&&O.current){const e=O.current.getBoundingClientRect(),r=y.current.getBoundingClientRect(),t=r.height||200,n=r.width||160,o=window.innerHeight,a=window.innerWidth;let s=e.bottom+5+t>o-20?Math.max(10,e.top-t-5):e.bottom+5;s<10&&(s=10),s+t>o-10&&(s=o-t-10);let i=a-e.right;e.right-n<10&&(i=10),f({top:Math.max(10,s),right:Math.max(10,Math.min(i,a-n-10))})}},10);return()=>clearTimeout(e)}},[E,e.length]),s.useEffect(()=>{const e=e=>{const r=e.target;y.current&&y.current.contains(r)||r.closest(".portal-dropdown-container")||E&&R(!1)},r=()=>{R(!1)},t=()=>{R(!1)},n=e=>{"Escape"===e.key&&R(!1)};if(E)return document.addEventListener("mousedown",e),window.addEventListener("scroll",r,!0),window.addEventListener("resize",t),document.addEventListener("keydown",n),()=>{document.removeEventListener("mousedown",e),window.removeEventListener("scroll",r,!0),window.removeEventListener("resize",t),document.removeEventListener("keydown",n)}},[E]);const w=e=>{l||(r(e),R(!1))},_="sm"===h?"h-8 px-3 text-xs":"h-9 px-4 text-sm",b="sm"===h?"h-3 w-3":"h-4 w-4";return t.jsxs("div",{className:`portal-dropdown-container ${n}`,children:[t.jsx(o,{ref:O,variant:"ghost",size:h,className:"dots"===x?"h-8 w-8 p-0":_,onClick:e=>{e.stopPropagation(),l||R(!E)},disabled:l,id:m,"aria-label":c,children:"dots"===x?t.jsx(d,{className:b}):t.jsxs(t.Fragment,{children:[t.jsx("span",{children:"Actions"}),t.jsx(a,{className:`${b} ml-1`})]})}),E&&i.createPortal(t.jsx("div",{ref:y,className:"fixed bg-white border border-gray-300 rounded-md shadow-xl z-50 min-w-[160px] max-w-[200px] max-h-[300px] overflow-y-auto",style:{top:`${N.top}px`,right:`${N.right}px`,zIndex:999999},children:t.jsxs("div",{className:"py-1",children:[null==(p=g.main)?void 0:p.map(e=>e.isMoveAction&&e.carId&&e.currentFloor&&e.tableContext?t.jsx("div",{children:t.jsx(u,{carId:e.carId,currentFloor:e.currentFloor,tableContext:e.tableContext})},e.value):e.isReceiveAction&&e.orderedId?t.jsx("div",{children:t.jsx(v,{orderedId:e.orderedId})},e.value):t.jsxs("button",{className:"w-full text-left px-4 py-2 text-sm hover:bg-gray-100 flex items-center transition-colors "+(e.disabled?"opacity-50 cursor-not-allowed":"cursor-pointer"),onMouseDown:r=>{r.stopPropagation(),e.disabled||w(e.value)},disabled:e.disabled,children:[e.icon&&t.jsx("span",{className:"mr-2",children:e.icon}),e.label]},e.value)),Object.entries(g).map(([e,r])=>"main"===e?null:t.jsxs("div",{children:[t.jsx("div",{className:"border-t border-gray-200 my-1"}),t.jsx("div",{className:"px-3 py-1 text-xs font-medium text-gray-500 uppercase tracking-wider",children:e}),r.map(e=>t.jsxs("button",{className:"w-full text-left px-4 py-2 text-sm hover:bg-gray-100 flex items-center transition-colors "+(e.disabled?"opacity-50 cursor-not-allowed":"cursor-pointer"),onMouseDown:r=>{r.stopPropagation(),e.disabled||w(e.value)},disabled:e.disabled,children:[e.icon&&t.jsx("span",{className:"mr-2",children:e.icon}),e.label]},e.value))]},e))]})}),document.body)]})};export{x as S};
