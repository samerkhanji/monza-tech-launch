var e=Object.defineProperty,s=Object.getOwnPropertySymbols,r=Object.prototype.hasOwnProperty,a=Object.prototype.propertyIsEnumerable,t=(s,r,a)=>r in s?e(s,r,{enumerable:!0,configurable:!0,writable:!0,value:a}):s[r]=a,l=(e,l)=>{for(var i in l||(l={}))r.call(l,i)&&t(e,i,l[i]);if(s)for(var i of s(l))a.call(l,i)&&t(e,i,l[i]);return e},i=(e,s,r)=>new Promise((a,t)=>{var l=e=>{try{n(r.next(e))}catch(s){t(s)}},i=e=>{try{n(r.throw(e))}catch(s){t(s)}},n=e=>e.done?a(e.value):Promise.resolve(e.value).then(l,i);n((r=r.apply(e,s)).next())});import{s as n,t as d,j as o,C as c,g as m,h as x,am as u,R as h,a as p,d as j,U as f,k as v,aQ as b,K as g}from"./index-BmUpYGrm.js";import{r as N}from"./vendor-vN6PtkFd.js";import{U as y}from"./user-plus-D_7NBtOn.js";import{L as w}from"./lock-BHJDt_OW.js";import"./charts-XrXYWaKo.js";import"./utils-DhcIvS4g.js";function _(){const[e,s]=N.useState([]),[r,a]=N.useState([]),[t,b]=N.useState([]),[g,w]=N.useState({}),[_,k]=N.useState(!0);N.useEffect(()=>{E()},[]);const E=()=>i(this,null,function*(){try{k(!0);const{data:e,error:r}=yield n.from("user_profiles").select("id, full_name, phone, created_at").order("created_at",{ascending:!1});if(r)return void d({title:"Error",description:"Failed to load users",variant:"destructive"});const{data:t,error:l}=yield n.from("roles").select("id, label").order("label");if(l)return void d({title:"Error",description:"Failed to load roles",variant:"destructive"});const{data:i,error:o}=yield n.from("user_roles").select("user_id, role_id");if(o)return void d({title:"Error",description:"Failed to load user roles",variant:"destructive"});s(e||[]),a(t||[]),b(i||[]);const c={};(i||[]).forEach(e=>{c[e.user_id]||(c[e.user_id]=new Set),c[e.user_id].add(e.role_id)}),w(c)}catch(e){d({title:"Error",description:"Failed to load data",variant:"destructive"})}finally{k(!1)}}),O=(s,a)=>i(this,null,function*(){var t;try{if(null==(t=g[s])?void 0:t.has(a)){const{error:t}=yield n.from("user_roles").delete().eq("user_id",s).eq("role_id",a);if(t)return void d({title:"Error",description:"Failed to remove role",variant:"destructive"});const i=l({},g);i[s]&&i[s].delete(a),w(i);const o=e.find(e=>e.id===s),c=r.find(e=>e.id===a);d({title:"Role Removed",description:`Removed ${null==c?void 0:c.label} role from ${(null==o?void 0:o.full_name)||"user"}`})}else{const{error:t}=yield n.from("user_roles").insert({user_id:s,role_id:a});if(t)return void d({title:"Error",description:"Failed to add role",variant:"destructive"});const i=l({},g);i[s]||(i[s]=new Set),i[s].add(a),w(i);const o=e.find(e=>e.id===s),c=r.find(e=>e.id===a);d({title:"Role Added",description:`Added ${null==c?void 0:c.label} role to ${(null==o?void 0:o.full_name)||"user"}`})}}catch(i){d({title:"Error",description:"Failed to update role",variant:"destructive"})}}),S=e=>{switch(e){case"owner":return"bg-red-100 text-red-800 border-red-200";case"garage_manager":return"bg-blue-100 text-blue-800 border-blue-200";case"sales":return"bg-green-100 text-green-800 border-green-200";case"assistant":return"bg-purple-100 text-purple-800 border-purple-200";case"technician":return"bg-orange-100 text-orange-800 border-orange-200";case"marketing":return"bg-pink-100 text-pink-800 border-pink-200";default:return"bg-gray-100 text-gray-800 border-gray-200"}};return _?o.jsx("div",{className:"flex items-center justify-center p-8",children:o.jsxs("div",{className:"text-center",children:[o.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-monza-yellow mx-auto mb-4"}),o.jsx("p",{className:"text-muted-foreground",children:"Loading users and roles..."})]})}):o.jsx("div",{className:"p-6 space-y-6",children:o.jsxs(c,{children:[o.jsxs(m,{children:[o.jsxs(x,{className:"flex items-center gap-2",children:[o.jsx(u,{className:"h-5 w-5"}),"User Role Management"]}),o.jsx(h,{children:"Manage user roles and permissions for the Monza TECH system. Users can have multiple roles for hybrid responsibilities."})]}),o.jsxs(p,{children:[o.jsx("div",{className:"mb-6 p-4 bg-yellow-50 border border-yellow-200 rounded-lg",children:o.jsxs("div",{className:"flex items-start gap-2",children:[o.jsx(j,{className:"h-4 w-4 text-yellow-600 mt-0.5"}),o.jsxs("div",{className:"text-sm text-yellow-800",children:[o.jsx("p",{className:"font-medium mb-1",children:"Important Notes:"}),o.jsxs("ul",{className:"list-disc list-inside space-y-1 text-xs",children:[o.jsx("li",{children:"Owners have all permissions automatically"}),o.jsx("li",{children:"Hybrid roles are supported (e.g., Khalil can be both Sales + Garage Manager)"}),o.jsx("li",{children:"Changes take effect immediately"}),o.jsx("li",{children:"Only users with admin.manage_users permission can access this page"})]})]})]})}),o.jsx("div",{className:"space-y-4",children:e.map(e=>{var s;return o.jsx(c,{className:"border border-gray-200",children:o.jsxs(p,{className:"p-4",children:[o.jsxs("div",{className:"flex items-start justify-between mb-4",children:[o.jsxs("div",{className:"flex items-center gap-3",children:[o.jsx("div",{className:"bg-monza-yellow p-2 rounded-full",children:o.jsx(f,{className:"h-4 w-4 text-monza-black"})}),o.jsxs("div",{children:[o.jsx("h3",{className:"font-medium text-lg",children:e.full_name||"Unnamed User"}),o.jsxs("p",{className:"text-sm text-muted-foreground",children:["ID: ",e.id.slice(0,8),"..."]}),e.phone&&o.jsxs("p",{className:"text-xs text-muted-foreground",children:["ðŸ“ž ",e.phone]})]})]}),o.jsxs("div",{className:"text-right",children:[o.jsxs("p",{className:"text-xs text-muted-foreground",children:["Joined: ",new Date(e.created_at).toLocaleDateString()]}),o.jsxs("p",{className:"text-xs font-medium",children:[(null==(s=g[e.id])?void 0:s.size)||0," role(s)"]})]})]}),o.jsxs("div",{className:"space-y-3",children:[o.jsx("h4",{className:"text-sm font-medium text-gray-700",children:"Assigned Roles:"}),o.jsx("div",{className:"flex gap-2 flex-wrap",children:r.map(s=>{var r;const a=null==(r=g[e.id])?void 0:r.has(s.id);return o.jsxs(v,{variant:a?"default":"outline",size:"sm",onClick:()=>O(e.id,s.id),className:`\n                              ${a?S(s.id)+" border":"border-gray-300 hover:border-gray-400"}\n                              transition-all duration-200\n                            `,children:[s.label,a&&o.jsx("span",{className:"ml-1 font-bold",children:"âœ“"})]},s.id)})})]})]})},e.id)})}),0===e.length&&o.jsxs("div",{className:"text-center py-8",children:[o.jsx(y,{className:"h-12 w-12 text-muted-foreground mx-auto mb-4"}),o.jsx("p",{className:"text-muted-foreground",children:"No users found"}),o.jsx("p",{className:"text-sm text-muted-foreground",children:"Users will appear here after they sign up or are created"})]})]})]})})}const k=({user:e})=>o.jsx("div",{className:"container mx-auto py-12",children:o.jsx(c,{className:"max-w-md mx-auto",children:o.jsxs(p,{className:"p-8 text-center",children:[o.jsx("div",{className:"bg-red-50 p-4 rounded-full w-16 h-16 mx-auto mb-4 flex items-center justify-center",children:o.jsx(w,{className:"h-8 w-8 text-red-600"})}),o.jsx("h2",{className:"text-xl font-semibold mb-2 text-red-800",children:"Access Denied"}),o.jsx("p",{className:"text-red-600 mb-4",children:"You don't have permission to access user management."}),e&&o.jsxs("p",{className:"text-sm text-gray-600 mb-2",children:["Current user: ",e.name," (",e.role,")"]}),o.jsx("p",{className:"text-sm text-muted-foreground",children:"Only users with administrative privileges can manage user roles and permissions."})]})})}),E=()=>o.jsx("div",{className:"container mx-auto py-12",children:o.jsx(c,{className:"max-w-md mx-auto",children:o.jsxs(p,{className:"p-8 text-center",children:[o.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-monza-yellow mx-auto mb-4"}),o.jsx("p",{className:"text-muted-foreground",children:"Checking permissions..."})]})})});function O(){const{can:e,isLoading:s}=b(),{user:r}=g();if(s)return o.jsx(E,{});const a="OWNER"===(null==r?void 0:r.role);return e("admin.manage_users")||a?o.jsxs("div",{className:"container mx-auto py-6",children:[o.jsxs("div",{className:"mb-6",children:[o.jsxs("div",{className:"flex items-center gap-3 mb-2",children:[o.jsx("div",{className:"bg-monza-yellow p-2 rounded-lg",children:o.jsx(u,{className:"h-6 w-6 text-monza-black"})}),o.jsxs("div",{children:[o.jsx("h1",{className:"text-3xl font-bold text-monza-black",children:"User Administration"}),o.jsx("p",{className:"text-muted-foreground",children:"Manage user roles and permissions"})]})]}),o.jsx(c,{className:"border-yellow-200 bg-yellow-50",children:o.jsx(p,{className:"p-4",children:o.jsxs("div",{className:"flex items-start gap-2",children:[o.jsx(j,{className:"h-4 w-4 text-yellow-600 mt-0.5"}),o.jsxs("div",{className:"text-sm text-yellow-800",children:[o.jsx("p",{className:"font-medium mb-1",children:"System Information:"}),o.jsxs("ul",{className:"list-disc list-inside space-y-1 text-xs",children:[o.jsx("li",{children:"Role changes take effect immediately"}),o.jsx("li",{children:"Hybrid roles are supported (users can have multiple roles)"}),o.jsx("li",{children:"Owners automatically have all permissions"}),o.jsx("li",{children:"This page is only accessible to users with admin.manage_users permission"})]})]})]})})})]}),o.jsx(_,{})]}):o.jsx(k,{user:r})}export{O as default};
