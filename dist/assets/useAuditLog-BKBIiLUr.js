var e=Object.defineProperty,t=Object.getOwnPropertySymbols,o=Object.prototype.hasOwnProperty,a=Object.prototype.propertyIsEnumerable,r=(t,o,a)=>o in t?e(t,o,{enumerable:!0,configurable:!0,writable:!0,value:a}):t[o]=a,i=(e,i)=>{for(var n in i||(i={}))o.call(i,n)&&r(e,n,i[n]);if(t)for(var n of t(i))a.call(i,n)&&r(e,n,i[n]);return e};import{r as n}from"./vendor-vN6PtkFd.js";import{K as s}from"./index-BmUpYGrm.js";const l=()=>{const[e,t]=n.useState([]),[o,a]=n.useState(!1),{user:r}=s();n.useEffect(()=>{localStorage.removeItem("auditLogs"),t([])},[]);const l=n.useCallback(e=>{localStorage.setItem("auditLogs",JSON.stringify(e)),t(e)},[]),c=n.useCallback((e,t,o,a,n)=>{if(!r)return;const s=navigator.userAgent,c=/Mobile|Android|iPhone|iPad/.test(s)?/iPad/.test(s)?"tablet":"mobile":"desktop",u=s.includes("Chrome")?"Chrome":s.includes("Firefox")?"Firefox":s.includes("Safari")?"Safari":"Other",d=[{id:`audit_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,timestamp:(new Date).toISOString(),userId:r.id,userName:r.name,userRole:r.role,action:e,section:t,entityType:o,entityId:null==n?void 0:n.entityId,entityName:null==n?void 0:n.entityName,details:a,vinNumber:null==n?void 0:n.vinNumber,partNumber:null==n?void 0:n.partNumber,carModel:null==n?void 0:n.carModel,carBrand:null==n?void 0:n.carBrand,category:null==n?void 0:n.category,location:null==n?void 0:n.location,changes:null==n?void 0:n.changes,metadata:i({userAgent:navigator.userAgent,sessionId:sessionStorage.getItem("sessionId")||"unknown",pageUrl:window.location.href,deviceType:c,browserName:u},null==n?void 0:n.metadata)},...JSON.parse(localStorage.getItem("auditLogs")||"[]")].slice(0,1e4);l(d)},[r,l]),u=n.useCallback(t=>e.filter(e=>{var o,a,r,i,n,s,l,c,u,d,m,v,w;const g=!t.section||e.section===t.section,y=!t.action||e.action===t.action,p=!t.userId||e.userId===t.userId,C=!t.entityType||e.entityType===t.entityType,b=!t.dateFrom||new Date(e.timestamp)>=new Date(t.dateFrom),L=!t.dateTo||new Date(e.timestamp)<=new Date(t.dateTo),f=!t.searchTerm||e.details.toLowerCase().includes(t.searchTerm.toLowerCase())||e.userName.toLowerCase().includes(t.searchTerm.toLowerCase())||(null==(o=e.entityName)?void 0:o.toLowerCase().includes(t.searchTerm.toLowerCase()))||(null==(a=e.vinNumber)?void 0:a.toLowerCase().includes(t.searchTerm.toLowerCase()))||(null==(r=e.partNumber)?void 0:r.toLowerCase().includes(t.searchTerm.toLowerCase()))||(null==(i=e.carModel)?void 0:i.toLowerCase().includes(t.searchTerm.toLowerCase()))||(null==(n=e.carBrand)?void 0:n.toLowerCase().includes(t.searchTerm.toLowerCase()))||(null==(s=e.category)?void 0:s.toLowerCase().includes(t.searchTerm.toLowerCase()))||(null==(l=e.location)?void 0:l.toLowerCase().includes(t.searchTerm.toLowerCase())),N=!t.vinNumber||(null==(c=e.vinNumber)?void 0:c.toLowerCase().includes(t.vinNumber.toLowerCase())),h=!t.partNumber||(null==(u=e.partNumber)?void 0:u.toLowerCase().includes(t.partNumber.toLowerCase())),S=!t.carModel||(null==(d=e.carModel)?void 0:d.toLowerCase().includes(t.carModel.toLowerCase())),A=!t.carBrand||(null==(m=e.carBrand)?void 0:m.toLowerCase().includes(t.carBrand.toLowerCase())),D=!t.category||(null==(v=e.category)?void 0:v.toLowerCase().includes(t.category.toLowerCase())),T=!t.location||(null==(w=e.location)?void 0:w.toLowerCase().includes(t.location.toLowerCase()));return g&&y&&p&&C&&b&&L&&f&&N&&h&&S&&A&&D&&T}),[e]),d=n.useCallback(()=>{const t=(new Date).toDateString(),o=e.filter(e=>new Date(e.timestamp).toDateString()===t),a=new Set(o.map(e=>e.userId)).size,r=Object.entries(e.reduce((e,t)=>(e[t.section]||(e[t.section]={count:0,lastActivity:t.timestamp}),e[t.section].count++,new Date(t.timestamp)>new Date(e[t.section].lastActivity)&&(e[t.section].lastActivity=t.timestamp),e),{})).map(([e,t])=>({section:e,count:t.count,lastActivity:t.lastActivity})).sort((e,t)=>new Date(t.lastActivity).getTime()-new Date(e.lastActivity).getTime());return{totalActivities:e.length,todayActivities:o.length,activeUsers:a,sectionsActivity:r}},[e]),m=n.useCallback(t=>{var o;const a=e.filter(e=>e.userId===t);if(0===a.length)return null;const r=(new Date).toDateString(),i=a.filter(e=>new Date(e.timestamp).toDateString()===r),n=Object.entries(a.reduce((e,t)=>(e[t.action]=(e[t.action]||0)+1,e),{})).map(([e,t])=>({action:e,count:t})).sort((e,t)=>t.count-e.count),s=Object.entries(a.reduce((e,t)=>(e[t.section]=(e[t.section]||0)+1,e),{})).map(([e,t])=>({section:e,count:t})).sort((e,t)=>t.count-e.count),l=a[0];return{userId:t,userName:l.userName,userRole:l.userRole,totalActivities:a.length,todayActivities:i.length,lastActivity:a[0].timestamp,mostActiveSection:(null==(o=s[0])?void 0:o.section)||"None",activityBreakdown:n,sectionBreakdown:s,recentActivities:a.slice(0,20)}},[e]),v=n.useCallback(()=>[...new Set(e.map(e=>e.userId))].map(e=>m(e)).filter(e=>null!==e),[e,m]),w=n.useCallback(t=>{if(!t.trim())return e;const o=t.toLowerCase().split(" ").filter(e=>e.length>0);return e.filter(e=>{const t=[e.details,e.userName,e.entityName,e.vinNumber,e.partNumber,e.carModel,e.carBrand,e.category,e.location,e.section.replace("_"," "),e.action,e.entityType].filter(Boolean).join(" ").toLowerCase();return o.every(e=>t.includes(e))})},[e]),g=n.useCallback(()=>{const t=new Date;t.setDate(t.getDate()-30);const o=e.filter(e=>new Date(e.timestamp)>t);l(o)},[e,l]);return{auditLogs:e,loading:o,logActivity:c,filterLogs:u,getAuditStats:d,getEmployeeAuditSummary:m,getAllEmployeesAuditSummary:v,advancedSearch:w,clearOldLogs:g}};export{l as u};
