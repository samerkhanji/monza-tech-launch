var e=Object.defineProperty,t=Object.defineProperties,r=Object.getOwnPropertyDescriptors,o=Object.getOwnPropertySymbols,s=Object.prototype.hasOwnProperty,i=Object.prototype.propertyIsEnumerable,a=(t,r,o)=>r in t?e(t,r,{enumerable:!0,configurable:!0,writable:!0,value:o}):t[r]=o,n=(e,t)=>{for(var r in t||(t={}))s.call(t,r)&&a(e,r,t[r]);if(o)for(var r of o(t))i.call(t,r)&&a(e,r,t[r]);return e},l=(e,o)=>t(e,r(o)),u=(e,t,r)=>new Promise((o,s)=>{var i=e=>{try{n(r.next(e))}catch(t){s(t)}},a=e=>{try{n(r.throw(e))}catch(t){s(t)}},n=e=>e.done?o(e.value):Promise.resolve(e.value).then(i,a);n((r=r.apply(e,t)).next())});import{s as p}from"./index-BmUpYGrm.js";import{e as c}from"./enhancedMonzaBotService-CP3UVEVb.js";import"./vendor-vN6PtkFd.js";import"./charts-XrXYWaKo.js";import"./utils-DhcIvS4g.js";const d=e=>{if(Array.isArray(e))return e.map(e=>d(e));if(e&&"object"==typeof e){const t={};for(const[r,o]of Object.entries(e))t[r]=null===o?void 0:d(o);return t}return null===e?void 0:e},_=e=>e&&(e=>["easy","medium","hard","expert"].includes(e))(e)?e:"medium",h=e=>{try{const t=localStorage.getItem(e);return t?JSON.parse(t):[]}catch(t){return[]}},m=(e,t)=>{try{localStorage.setItem(e,JSON.stringify(t))}catch(r){}};class f{saveRepairHistory(e){return u(this,null,function*(){try{const r=l(n({},e),{parts_used:JSON.stringify(e.parts_used),difficulty_level:_(e.difficulty_level),id:`repair_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,created_at:(new Date).toISOString(),updated_at:(new Date).toISOString()});try{const{data:e,error:t}=yield p.from("audit_logs").insert([{table_name:"enhanced_repair_history",record_id:r.id,action:"INSERT",new_data:r,user_id:"system",user_email:"system@monza.tech",user_role:"system",ip_address:"127.0.0.1",user_agent:"MonzaTech-System",timestamp:(new Date).toISOString()}]).select().single();if(t)throw t}catch(t){}const o=h("enhanced_repair_history");o.push(r),m("enhanced_repair_history",o);const s=l(n({},r),{parts_used:"string"==typeof r.parts_used?JSON.parse(r.parts_used):r.parts_used,difficulty_level:_(r.difficulty_level)});return yield this.updatePartsKnowledge(e.parts_used,e.car_model),yield this.saveRepairSolution(e),yield this.notifyMonzaBotLearning(s),s}catch(r){return null}})}getCarRepairHistory(e){return u(this,null,function*(){try{try{const{data:t,error:r}=yield p.from("audit_logs").select("*").eq("table_name","enhanced_repair_history").contains("new_data",{car_vin:e}).order("timestamp",{ascending:!1});if(!r&&t)return t.map(e=>e.new_data).filter(Boolean).map(e=>d(l(n({},e),{parts_used:"string"==typeof e.parts_used?JSON.parse(e.parts_used):e.parts_used,difficulty_level:_(e.difficulty_level)})))}catch(t){}return h("enhanced_repair_history").filter(t=>t.car_vin===e).map(e=>d(l(n({},e),{parts_used:"string"==typeof e.parts_used?JSON.parse(e.parts_used):e.parts_used,difficulty_level:_(e.difficulty_level)})))}catch(r){return[]}})}getClientRepairHistory(e){return u(this,null,function*(){try{try{const{data:t,error:r}=yield p.from("audit_logs").select("*").eq("table_name","enhanced_repair_history").ilike("new_data->client_name",`%${e}%`).order("timestamp",{ascending:!1});if(!r&&t)return t.map(e=>e.new_data).filter(Boolean).map(e=>d(l(n({},e),{parts_used:"string"==typeof e.parts_used?JSON.parse(e.parts_used):e.parts_used,difficulty_level:_(e.difficulty_level)})))}catch(t){}return h("enhanced_repair_history").filter(t=>{var r;return null==(r=t.client_name)?void 0:r.toLowerCase().includes(e.toLowerCase())}).map(e=>d(l(n({},e),{parts_used:"string"==typeof e.parts_used?JSON.parse(e.parts_used):e.parts_used,difficulty_level:_(e.difficulty_level)})))}catch(r){return[]}})}searchRepairHistory(e){return u(this,null,function*(){try{try{const{data:t,error:r}=yield p.from("audit_logs").select("*").eq("table_name","enhanced_repair_history").or(`new_data->car_vin.ilike.%${e}%,new_data->client_name.ilike.%${e}%,new_data->issue_description.ilike.%${e}%,new_data->solution_description.ilike.%${e}%`).order("timestamp",{ascending:!1});if(!r&&t)return t.map(e=>e.new_data).filter(Boolean).map(e=>d(l(n({},e),{parts_used:"string"==typeof e.parts_used?JSON.parse(e.parts_used):e.parts_used,difficulty_level:_(e.difficulty_level)})))}catch(t){}const r=h("enhanced_repair_history"),o=e.toLowerCase();return r.filter(e=>{var t,r,s,i;return(null==(t=e.car_vin)?void 0:t.toLowerCase().includes(o))||(null==(r=e.client_name)?void 0:r.toLowerCase().includes(o))||(null==(s=e.issue_description)?void 0:s.toLowerCase().includes(o))||(null==(i=e.solution_description)?void 0:i.toLowerCase().includes(o))}).map(e=>d(l(n({},e),{parts_used:"string"==typeof e.parts_used?JSON.parse(e.parts_used):e.parts_used,difficulty_level:_(e.difficulty_level)})))}catch(r){return[]}})}updatePartsKnowledge(e,t){return u(this,null,function*(){try{const r=h("parts_knowledge_base");for(const o of e){const e=r.find(e=>e.part_number===o.part_number);if(e){const r=e.compatible_models||[],o=Array.isArray(r)?[...new Set([...r,t])]:[t];e.compatible_models=o,e.usage_count=(e.usage_count||0)+1,e.updated_at=(new Date).toISOString()}else r.push({id:`part_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,part_number:o.part_number,part_name:o.part_name,compatible_models:[t],usage_count:1,installation_difficulty:"medium",created_at:(new Date).toISOString(),updated_at:(new Date).toISOString()})}m("parts_knowledge_base",r)}catch(r){}})}saveRepairSolution(e){return u(this,null,function*(){try{const t=e.issue_description.toLowerCase().split(/\s+/).filter(e=>e.length>3).slice(0,10),r={id:`solution_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,issue_keywords:t,issue_description:e.issue_description,solution_description:e.solution_description,repair_steps:e.repair_steps,required_parts:JSON.stringify(e.parts_used),estimated_time_hours:e.labor_hours,difficulty_level:_(e.difficulty_level),car_models:[e.car_model],technician_notes:`Completed by ${e.technician_name}`,photos:e.after_photos||[],usage_count:1,effectiveness_rating:e.quality_rating,created_at:(new Date).toISOString(),updated_at:(new Date).toISOString()},o=h("repair_solutions_kb");o.push(r),m("repair_solutions_kb",o)}catch(t){}})}notifyMonzaBotLearning(e){return u(this,null,function*(){try{const t=`New repair completed for ${e.car_model}:\n        Issue: ${e.issue_description}\n        Solution: ${e.solution_description}\n        Parts used: ${e.parts_used.map(e=>e.part_name).join(", ")}\n        Duration: ${e.labor_hours} hours\n        Please learn from this repair case for future assistance.`;yield c.processEnhancedMessage(t,{source:"repair_learning",formType:"repair",extractedData:e})}catch(t){}})}getPartsKnowledge(e,t){return u(this,null,function*(){try{let r=h("parts_knowledge_base");return e&&(r=r.filter(t=>t.part_number===e)),t&&(r=r.filter(e=>{var r;return null==(r=e.compatible_models)?void 0:r.includes(t)})),r.sort((e,t)=>(t.usage_count||0)-(e.usage_count||0)),r.map(e=>{return l(n({},e),{installation_difficulty:(t=e.installation_difficulty,t&&(e=>["easy","medium","hard"].includes(e))(t)?t:"medium")});var t})}catch(r){return[]}})}getRepairSolutions(e,t){return u(this,null,function*(){try{let r=h("repair_solutions_kb");t&&(r=r.filter(e=>{var r;return null==(r=e.car_models)?void 0:r.includes(t)}));return r.filter(t=>e.some(e=>{var r;return null==(r=t.issue_keywords)?void 0:r.some(t=>t.includes(e.toLowerCase()))})).map(e=>l(n({},e),{required_parts:"string"==typeof e.required_parts?JSON.parse(e.required_parts):e.required_parts,difficulty_level:_(e.difficulty_level)}))}catch(r){return[]}})}saveRepairHistoryWithPhotos(e){return u(this,arguments,function*(e,t=[]){try{const r=l(n({},e),{photos:t.map(e=>e.dataUrl),before_photos:t.filter(e=>"before"===e.photoType).map(e=>e.dataUrl),after_photos:t.filter(e=>"after"===e.photoType).map(e=>e.dataUrl),photo_documentation:{totalPhotos:t.length,photoTypes:t.reduce((e,t)=>(e[t.photoType]=(e[t.photoType]||0)+1,e),{}),photoDescriptions:t.map(e=>({type:e.photoType,description:e.description,timestamp:e.timestamp,mechanicName:e.mechanicName})),documentationQuality:this.assessDocumentationQuality(t)}}),o=yield this.saveRepairHistory(r);return o&&t.length>0&&(yield this.notifyMonzaBotPhotoLearning(o,t)),o}catch(r){return null}})}assessDocumentationQuality(e){if(0===e.length)return{score:0,feedback:"No photos provided"};const t=e.some(e=>"before"===e.photoType),r=e.some(e=>"after"===e.photoType),o=e.some(e=>"during"===e.photoType),s=e.some(e=>"issue"===e.photoType),i=e.every(e=>e.description&&e.description.length>10),a=e.every(e=>e.description&&e.description.length>30);let n=0;const l=[];return t?n+=25:l.push("Missing before photos"),r?n+=25:l.push("Missing after photos"),o?n+=15:l.push("Consider adding during-repair photos"),s?n+=10:l.push("Consider documenting specific issues"),i?n+=15:l.push("Some photos lack descriptions"),a?n+=10:l.push("Photo descriptions could be more detailed"),{score:n,grade:n>=80?"Excellent":n>=60?"Good":n>=40?"Fair":"Poor",feedback:l.join("; "),recommendations:this.getDocumentationRecommendations(n,{hasBeforePhotos:t,hasAfterPhotos:r,hasDuringPhotos:o,hasIssuePhotos:s,allHaveDescriptions:i,descriptionsDetailed:a})}}getDocumentationRecommendations(e,t){const r=[];return t.hasBeforePhotos||r.push("Always take before photos to document initial condition"),t.hasAfterPhotos||r.push("Take after photos to show completed work quality"),t.hasDuringPhotos||r.push("Document key repair steps with during-repair photos"),t.hasIssuePhotos||r.push("Document specific issues found for future reference"),t.allHaveDescriptions||r.push("Add detailed descriptions to all photos"),t.descriptionsDetailed||r.push("Include more technical details in photo descriptions"),e>=80&&r.push("Excellent documentation! This will greatly help future repairs."),r}notifyMonzaBotPhotoLearning(e,t){return u(this,null,function*(){var r,o;try{const s=t.map(e=>`${e.photoType}: ${e.description}`).join("; ");e.car_model,e.issue_description,e.solution_description,e.parts_used.map(e=>e.part_name).join(", "),e.labor_hours,t.length,null==(r=e.photo_documentation)||r.grade;yield c.learnFromRepairPhotos({carModel:e.car_model,carCode:e.car_vin,customerName:e.client_name,mechanicName:e.technician_name,issueDescription:e.issue_description,workNotes:e.solution_description,repairPhotos:t,beforePhotos:t.filter(e=>"before"===e.photoType),duringPhotos:t.filter(e=>"during"===e.photoType),afterPhotos:t.filter(e=>"after"===e.photoType),issuePhotos:t.filter(e=>"issue"===e.photoType),photoCount:t.length,timestamp:e.completion_date||(new Date).toISOString(),status:"completed",tags:["photo_documentation","repair_session",e.car_model.toLowerCase()],monzaBotLearning:{hasPhotos:!0,photoCount:t.length,issuesDocumented:t.filter(e=>"issue"===e.photoType).length,repairProgress:t.filter(e=>["before","during","after"].includes(e.photoType)).length,learningTriggered:!0,lastLearningDate:(new Date).toISOString(),documentationQuality:(null==(o=e.photo_documentation)?void 0:o.score)||0}})}catch(s){}})}getPhotoBasedRepairSuggestions(e,t){return u(this,null,function*(){try{const r=JSON.parse(localStorage.getItem("enhanced_repair_sessions")||"[]").filter(r=>{var o,s;return(null==(o=r.monzaBotLearning)?void 0:o.hasPhotos)&&(null==(s=r.monzaBotLearning)?void 0:s.documentationQuality)>=60&&(r.carModel.toLowerCase().includes(e.toLowerCase())||r.issueDescription.toLowerCase().includes(t.toLowerCase()))});if(r.length>0){const o=yield c.getRepairSuggestions(e,t);return r.map(e=>l(n({},e),{monzaBotSuggestions:o.textResponse}))}return[]}catch(r){return[]}})}searchRepairsByPhotoContent(e){return u(this,null,function*(){try{const t=yield this.searchRepairHistory(e),r=JSON.parse(localStorage.getItem("enhanced_repair_sessions")||"[]"),o=r.filter(t=>!!t.repairPhotos&&(t.repairPhotos.some(t=>t.description.toLowerCase().includes(e.toLowerCase()))||t.issueDescription.toLowerCase().includes(e.toLowerCase()))).map(e=>{var t,r,o;return{id:e.id,car_vin:e.carCode,car_model:e.carModel,client_name:e.customerName,issue_description:e.issueDescription,solution_description:e.workNotes,technician_name:e.mechanicName,repair_date:e.timestamp.split("T")[0],completion_date:e.timestamp.split("T")[0],photos:(null==(t=e.repairPhotos)?void 0:t.map(e=>e.dataUrl))||[],before_photos:(null==(r=e.beforePhotos)?void 0:r.map(e=>e.dataUrl))||[],after_photos:(null==(o=e.afterPhotos)?void 0:o.map(e=>e.dataUrl))||[],parts_used:[],labor_hours:0,created_at:e.timestamp,updated_at:e.timestamp}}),s=[...t,...o];return s.filter((e,t,r)=>t===r.findIndex(t=>t.car_vin===e.car_vin&&t.repair_date===e.repair_date))}catch(t){return[]}})}}const y=new f;export{f as EnhancedRepairHistoryService,y as enhancedRepairHistoryService};
