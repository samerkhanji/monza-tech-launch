var e=Object.defineProperty,t=Object.defineProperties,s=Object.getOwnPropertyDescriptors,a=Object.getOwnPropertySymbols,r=Object.prototype.hasOwnProperty,i=Object.prototype.propertyIsEnumerable,l=(t,s,a)=>s in t?e(t,s,{enumerable:!0,configurable:!0,writable:!0,value:a}):t[s]=a,n=(e,t)=>{for(var s in t||(t={}))r.call(t,s)&&l(e,s,t[s]);if(a)for(var s of a(t))i.call(t,s)&&l(e,s,t[s]);return e},c=(e,a)=>t(e,s(a)),o=(e,t,s)=>new Promise((a,r)=>{var i=e=>{try{n(s.next(e))}catch(t){r(t)}},l=e=>{try{n(s.throw(e))}catch(t){r(t)}},n=e=>e.done?a(e.value):Promise.resolve(e.value).then(i,l);n((s=s.apply(e,t)).next())});import{u as d,K as m,t as x,j as h,k as v,C as u,g as N,h as p,a7 as f,e as j,a as g,a3 as b,b as y,L as T,I as w,U as S,y as C,z as D,E as I,F as E,o as V,H as R,m as k}from"./index-BmUpYGrm.js";import{r as _}from"./vendor-vN6PtkFd.js";import{u as A}from"./cameraPermissionManager-D3sOAAEG.js";import{e as P}from"./ocrUtils-boR-SCDU.js";import{enhancedRepairHistoryService as O}from"./enhancedRepairHistoryService-DfLNwEz9.js";import{A as $}from"./arrow-left-DqrDEplE.js";import{C as F}from"./camera-CKQtJJJ8.js";import{L as H}from"./loader-2-BYW_3amd.js";import{S as L}from"./stop-circle-DSXaWKMF.js";import{F as M}from"./file-text-bXPYLusF.js";import"./charts-XrXYWaKo.js";import"./utils-DhcIvS4g.js";import"./index-dUlNy-FG.js";import"./enhancedMonzaBotService-CP3UVEVb.js";const U=()=>{const e=d(),[t,s]=_.useState(!1),[a,r]=_.useState(null),[i,l]=_.useState([]),[U,J]=_.useState(!1),[q,z]=_.useState(null),[Z,B]=_.useState({isClientTestDrive:!0,driverName:"",clientName:"",testDriveNotes:""}),[W,Y]=_.useState(""),G=_.useRef(null),K=_.useRef(null),{user:Q}=m(),{granted:X,stream:ee,requestCamera:te,hasActiveStream:se}=A();_.useEffect(()=>{const e=localStorage.getItem("activeTestDrives");if(e){const t=JSON.parse(e);l(t.map(e=>c(n({},e),{startTime:new Date(e.startTime)})))}},[]),_.useEffect(()=>{localStorage.setItem("activeTestDrives",JSON.stringify(i))},[i]),_.useEffect(()=>{X&&!se&&ae()},[X,se]),_.useEffect(()=>{G.current&&ee&&(G.current.srcObject=ee,G.current.play().catch(console.error))},[ee]);const ae=()=>o(void 0,null,function*(){try{yield te({video:{facingMode:"environment",width:{ideal:1280},height:{ideal:720}}}),x({title:"üì∑ Camera Ready",description:"Point camera at VIN for INSTANT test drive start!"})}catch(e){x({title:"Camera Error",description:"Could not access camera. Use manual VIN entry instead.",variant:"destructive"})}}),re=e=>o(void 0,null,function*(){var t;const s=i.find(t=>t.vin===e);if(s)return void x({title:"Car Already on Test Drive",description:`This vehicle is currently being test driven by ${s.employeeScanned}`,variant:"destructive"});const a="Voyah Free",n=2024,c="Voyah",o=Q||{email:"Unknown User",user_metadata:{full_name:"Unknown Employee"}},d=(null==(t=null==o?void 0:o.user_metadata)?void 0:t.full_name)||o.email||"Unknown Employee",m=o.email||"unknown@monzasal.com",h={id:`td-${Date.now()}`,vin:e,carModel:`${n} ${c} ${a}`,startTime:new Date,employeeScanned:d,employeeEmail:m};l(e=>[...e,h]),r(null),Y("")}),ie=e=>{const t=new Date,s=Math.floor((t.getTime()-e.getTime())/1e3),a=Math.floor(s/3600),r=Math.floor(s%3600/60),i=s%60;return a>0?`${a}:${r.toString().padStart(2,"0")}:${i.toString().padStart(2,"0")}`:`${r}:${i.toString().padStart(2,"0")}`},le=({testDrive:e})=>{const[t,s]=_.useState("");return _.useEffect(()=>{const t=setInterval(()=>{s(ie(e.startTime))},1e3);return()=>clearInterval(t)},[e.startTime]),h.jsxs("tr",{className:"border-b border-gray-200 hover:bg-gray-50",children:[h.jsx("td",{className:"px-4 py-3",children:h.jsx("div",{className:"font-mono text-sm",children:e.vin})}),h.jsx("td",{className:"px-4 py-3",children:h.jsx("div",{className:"font-medium",children:e.carModel})}),h.jsx("td",{className:"px-4 py-3",children:h.jsxs("div",{className:"flex items-center gap-2",children:[h.jsx(V,{className:"h-4 w-4 text-blue-500"}),h.jsx("span",{className:"font-medium",children:e.employeeScanned})]})}),h.jsx("td",{className:"px-4 py-3",children:h.jsx("div",{className:"text-sm text-gray-600",children:e.startTime.toLocaleTimeString()})}),h.jsx("td",{className:"px-4 py-3",children:h.jsx("div",{className:"text-2xl font-mono font-bold text-green-600",children:t})}),h.jsx("td",{className:"px-4 py-3",children:h.jsxs(v,{onClick:()=>(e=>{z(e),B({isClientTestDrive:!0,driverName:e.employeeScanned,clientName:"",testDriveNotes:""}),J(!0)})(e),size:"sm",className:"bg-red-600 hover:bg-red-700 text-white",children:[h.jsx(L,{className:"h-4 w-4 mr-1"}),"END TEST DRIVE"]})})]})};return h.jsxs("div",{className:"container mx-auto p-6 space-y-6 max-w-6xl",children:[h.jsxs("div",{className:"flex items-center mb-8",children:[h.jsxs(v,{variant:"outline",size:"sm",className:"mr-4",onClick:()=>e(-1),children:[h.jsx($,{className:"mr-1 h-4 w-4"}),"Back"]}),h.jsxs("div",{className:"text-center flex-1",children:[h.jsx("h1",{className:"text-3xl font-bold text-gray-900 mb-2",children:"INSTANT Test Drive Scanner"}),h.jsx("p",{className:"text-gray-600 text-lg",children:"Scan VIN ‚Üí Car instantly taken for test drive ‚Üí Fill details when returning"})]})]}),i.length>0&&h.jsxs(u,{className:"border-green-200 bg-green-50 border-2",children:[h.jsx(N,{children:h.jsxs(p,{className:"flex items-center gap-2 text-green-700",children:[h.jsx(f,{className:"h-6 w-6"}),"üü¢ LIVE TEST DRIVES - CURRENTLY ACTIVE (",i.length,")",h.jsxs(j,{className:"bg-green-500 text-white px-3 py-1 text-sm",children:[i.length," Cars Out"]})]})}),h.jsx(g,{children:h.jsx("div",{className:"overflow-x-auto",children:h.jsxs("table",{className:"w-full",children:[h.jsx("thead",{children:h.jsxs("tr",{className:"border-b-2 border-green-300 bg-green-100",children:[h.jsx("th",{className:"px-4 py-3 text-left font-semibold",children:"VIN"}),h.jsx("th",{className:"px-4 py-3 text-left font-semibold",children:"Vehicle"}),h.jsx("th",{className:"px-4 py-3 text-left font-semibold",children:"Taken By"}),h.jsx("th",{className:"px-4 py-3 text-left font-semibold",children:"Start Time"}),h.jsx("th",{className:"px-4 py-3 text-left font-semibold",children:"Duration (Live)"}),h.jsx("th",{className:"px-4 py-3 text-left font-semibold",children:"Action"})]})}),h.jsx("tbody",{children:i.map(e=>h.jsx(le,{testDrive:e},e.id))})]})})})]}),h.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[h.jsxs(u,{className:"border-blue-300 bg-blue-50 border-2",children:[h.jsx(N,{children:h.jsxs(p,{className:"flex items-center gap-2 text-blue-700 text-xl",children:[h.jsx(b,{className:"h-6 w-6"}),"INSTANT VIN Scanner"]})}),h.jsxs(g,{className:"space-y-4",children:[h.jsxs("div",{className:"relative",children:[a?h.jsx("img",{src:a,alt:"Captured VIN",className:"w-full h-64 rounded-md object-contain border-2 border-blue-300"}):h.jsxs(h.Fragment,{children:[h.jsx("video",{ref:G,className:"w-full h-64 rounded-md bg-gray-100 object-cover border-2 border-blue-300",autoPlay:!0,playsInline:!0,muted:!0}),h.jsx("canvas",{ref:K,className:"hidden"})]}),!se&&!a&&h.jsx("div",{className:"absolute inset-0 flex items-center justify-center bg-gray-100 rounded-md",children:h.jsxs("div",{className:"text-center",children:[h.jsx(F,{className:"mx-auto h-12 w-12 text-gray-400 mb-2"}),h.jsx("p",{className:"text-sm text-gray-500",children:"Camera not active"})]})}),se&&!a&&h.jsx("div",{className:"absolute top-3 left-3",children:h.jsxs("div",{className:"flex items-center gap-2 bg-red-500 text-white px-3 py-2 rounded-full text-sm font-bold",children:[h.jsx("div",{className:"w-2 h-2 bg-white rounded-full animate-pulse"}),"LIVE - READY TO SCAN"]})})]}),h.jsx("div",{className:"flex gap-2",children:se?a?h.jsxs(h.Fragment,{children:[h.jsxs(v,{onClick:()=>o(void 0,null,function*(){if(a){s(!0);try{const e=yield P(a);if(e&&e.length>=5){const t=(e=>{const t=[/\b[A-HJ-NPR-Z0-9]{17}\b/gi,/(?:VIN|V\.I\.N|VEHICLE\s+ID|CHASSIS)[:#\s]*([A-HJ-NPR-Z0-9]{17})/gi];for(const s of t){const t=e.match(s);if(t)for(const e of t){const t=e.replace(/[^A-HJ-NPR-Z0-9]/gi,"").toUpperCase();if(17===t.length&&/^[A-HJ-NPR-Z0-9]{17}$/i.test(t))return t}}return null})(e);t?yield re(t):x({title:"No VIN Found",description:"Could not detect a valid VIN. Try manual entry below.",variant:"destructive"})}else x({title:"No Text Found",description:"Could not extract text from image. Ensure VIN is clearly visible.",variant:"destructive"})}catch(e){x({title:"OCR Error",description:"Failed to process image. Try manual VIN entry instead.",variant:"destructive"})}finally{s(!1)}}else x({title:"No VIN captured",description:"Please capture a VIN photo first.",variant:"destructive"})}),disabled:t,className:"flex-1 bg-green-600 hover:bg-green-700 text-white text-lg font-bold py-4",children:[t?h.jsx(H,{className:"h-5 w-5 mr-2 animate-spin"}):h.jsx(b,{className:"h-5 w-5 mr-2"}),t?"STARTING...":h.jsxs(h.Fragment,{children:[h.jsx(y,{className:"w-4 h-4 mr-2"}),"START INSTANT TEST DRIVE"]})]}),h.jsx(v,{onClick:()=>r(null),variant:"outline",className:"text-sm",children:"Retake"})]}):h.jsxs(v,{onClick:()=>{if(!G.current||!K.current)return void x({title:"Camera not ready",description:"Please ensure the camera is active before capturing.",variant:"destructive"});const e=G.current,t=K.current,s=t.getContext("2d");if(!s)return void x({title:"Canvas error",description:"Unable to capture photo. Please try again.",variant:"destructive"});t.width=e.videoWidth,t.height=e.videoHeight,s.drawImage(e,0,0,t.width,t.height);const a=t.toDataURL("image/jpeg",.9);r(a),x({title:"üì∏ VIN Captured",description:"Click 'START INSTANT TEST DRIVE' to begin immediately!"})},className:"flex-1 bg-blue-600 hover:bg-blue-700 text-lg font-bold py-3",children:[h.jsx(F,{className:"h-5 w-5 mr-2"}),"üì∏ CAPTURE VIN"]}):h.jsxs(v,{onClick:ae,className:"flex-1 bg-blue-600 hover:bg-blue-700",children:[h.jsx(F,{className:"h-4 w-4 mr-2"}),"Start Camera"]})}),h.jsxs("div",{className:"space-y-3 border-t-2 border-blue-200 pt-4",children:[h.jsx(T,{htmlFor:"manualVin",className:"text-base font-semibold",children:"‚å®Ô∏è Or Enter VIN Manually"}),h.jsxs("div",{className:"flex gap-2",children:[h.jsx(w,{id:"manualVin",value:W,onChange:e=>Y(e.target.value.toUpperCase()),placeholder:"Enter 17-character VIN",maxLength:17,className:"flex-1 h-12 text-base"}),h.jsxs(v,{onClick:()=>o(void 0,null,function*(){if(!W.trim())return void x({title:"VIN Required",description:"Please enter a VIN number",variant:"destructive"});const e=W.trim().toUpperCase();/^[A-HJ-NPR-Z0-9]{17}$/i.test(e)?yield re(e):x({title:"Invalid VIN",description:"VIN must be 17 characters long and contain only letters and numbers",variant:"destructive"})}),className:"bg-green-600 hover:bg-green-700 text-white font-bold px-6",children:[h.jsx(b,{className:"h-4 w-4 mr-2"}),"START!"]})]})]})]})]}),h.jsxs(u,{className:"border-yellow-300 bg-yellow-50 border-2",children:[h.jsx(N,{children:h.jsxs(p,{className:"flex items-center gap-2 text-yellow-700 text-xl",children:[h.jsx(S,{className:"h-6 w-6"}),"How Instant Test Drive Works"]})}),h.jsxs(g,{className:"space-y-4",children:[h.jsxs("div",{className:"space-y-4",children:[h.jsxs("div",{className:"flex items-start gap-3 p-3 bg-white rounded-lg border border-yellow-200",children:[h.jsx("div",{className:"w-8 h-8 bg-blue-500 text-white rounded-full flex items-center justify-center text-sm font-bold",children:"1"}),h.jsxs("div",{children:[h.jsx("h4",{className:"font-semibold text-blue-700",children:"Scan or Enter VIN"}),h.jsx("p",{className:"text-sm text-gray-600",children:"Point camera at VIN or type it manually"})]})]}),h.jsxs("div",{className:"flex items-start gap-3 p-3 bg-white rounded-lg border border-yellow-200",children:[h.jsx("div",{className:"w-8 h-8 bg-green-500 text-white rounded-full flex items-center justify-center text-sm font-bold",children:"2"}),h.jsxs("div",{children:[h.jsxs("h4",{className:"font-semibold text-green-700 flex items-center gap-2",children:[h.jsx(y,{className:"w-4 h-4"}),"INSTANT START!"]}),h.jsx("p",{className:"text-sm text-gray-600",children:"Test drive timer starts immediately - take the car and go!"})]})]}),h.jsxs("div",{className:"flex items-start gap-3 p-3 bg-white rounded-lg border border-yellow-200",children:[h.jsx("div",{className:"w-8 h-8 bg-orange-500 text-white rounded-full flex items-center justify-center text-sm font-bold",children:"3"}),h.jsxs("div",{children:[h.jsx("h4",{className:"font-semibold text-orange-700",children:"üïê Live Tracking"}),h.jsx("p",{className:"text-sm text-gray-600",children:"Your name and timer are logged automatically"})]})]}),h.jsxs("div",{className:"flex items-start gap-3 p-3 bg-white rounded-lg border border-yellow-200",children:[h.jsx("div",{className:"w-8 h-8 bg-red-500 text-white rounded-full flex items-center justify-center text-sm font-bold",children:"4"}),h.jsxs("div",{children:[h.jsx("h4",{className:"font-semibold text-red-700",children:"üõë End & Log Details"}),h.jsx("p",{className:"text-sm text-gray-600",children:'Click "END TEST DRIVE" and fill in client information'})]})]})]}),h.jsx("div",{className:"bg-green-100 p-4 rounded-lg border-2 border-green-300",children:h.jsx("p",{className:"text-sm font-bold text-green-800 text-center",children:"Perfect for quick test drives! No waiting, no forms upfront!"})})]})]})]}),h.jsx(C,{open:U,onOpenChange:J,children:h.jsxs(D,{className:"max-w-2xl",children:[h.jsx(I,{children:h.jsxs(E,{className:"flex items-center gap-2 text-red-600",children:[h.jsx(L,{className:"h-6 w-6"}),"üõë Complete Test Drive - Log Client Details"]})}),q&&h.jsxs("div",{className:"space-y-6",children:[h.jsxs("div",{className:"p-4 bg-blue-50 rounded-lg border-2 border-blue-200",children:[h.jsxs("h4",{className:"font-semibold mb-3 text-blue-700 flex items-center gap-2",children:[h.jsx(M,{className:"w-4 h-4"}),"Test Drive Summary"]}),h.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[h.jsxs("div",{children:[h.jsx("span",{className:"font-medium",children:"Vehicle:"}),h.jsx("p",{className:"font-semibold",children:q.carModel})]}),h.jsxs("div",{children:[h.jsx("span",{className:"font-medium",children:"VIN:"}),h.jsx("p",{className:"font-mono",children:q.vin})]}),h.jsxs("div",{children:[h.jsx("span",{className:"font-medium",children:"Taken by:"}),h.jsx("p",{className:"font-semibold text-blue-600",children:q.employeeScanned})]}),h.jsxs("div",{children:[h.jsx("span",{className:"font-medium",children:"Duration:"}),h.jsx("p",{className:"font-bold text-green-600",children:ie(q.startTime)})]})]})]}),h.jsxs("div",{className:"space-y-3",children:[h.jsxs(T,{className:"text-base font-semibold flex items-center gap-2",children:[h.jsx(y,{className:"w-4 h-4"}),"Test Drive Type"]}),h.jsxs("div",{className:"flex gap-2",children:[h.jsxs(v,{variant:Z.isClientTestDrive?"default":"outline",onClick:()=>B(e=>c(n({},e),{isClientTestDrive:!0})),className:"flex-1",children:[h.jsx(V,{className:"h-4 w-4 mr-2"}),"Client Test Drive"]}),h.jsx(v,{variant:Z.isClientTestDrive?"outline":"default",onClick:()=>B(e=>c(n({},e),{isClientTestDrive:!1})),className:"flex-1",children:"üë®‚Äçüíº Employee Test Drive"})]})]}),h.jsxs("div",{className:"space-y-4",children:[h.jsxs("div",{children:[h.jsxs(T,{htmlFor:"driverName",className:"text-base font-semibold flex items-center gap-2",children:[h.jsx(V,{className:"w-4 h-4"}),"Driver Name *"]}),h.jsx(w,{id:"driverName",value:Z.driverName,onChange:e=>B(t=>c(n({},t),{driverName:e.target.value})),placeholder:"Who actually drove the vehicle?",className:"h-12"})]}),Z.isClientTestDrive&&h.jsxs("div",{children:[h.jsxs(T,{htmlFor:"clientName",className:"text-base font-semibold flex items-center gap-2",children:[h.jsx(S,{className:"w-4 h-4"}),"Client Name *"]}),h.jsx(w,{id:"clientName",value:Z.clientName,onChange:e=>B(t=>c(n({},t),{clientName:e.target.value})),placeholder:"Client's full name",className:"h-12"})]}),h.jsxs("div",{children:[h.jsxs(T,{htmlFor:"testDriveNotes",className:"text-base font-semibold flex items-center gap-2",children:[h.jsx(M,{className:"w-4 h-4"}),"Test Drive Notes"]}),h.jsx(R,{id:"testDriveNotes",value:Z.testDriveNotes,onChange:e=>B(t=>c(n({},t),{testDriveNotes:e.target.value})),placeholder:"How was the test drive? Any observations, client feedback, issues...",rows:4,className:"text-base"})]})]}),h.jsxs("div",{className:"flex gap-3 justify-end pt-4 border-t",children:[h.jsx(v,{variant:"outline",onClick:()=>J(!1),className:"px-6",children:"Cancel"}),h.jsxs(v,{onClick:()=>o(void 0,null,function*(){var e;if(!q)return;if(!Z.driverName.trim())return void x({title:"Driver Name Required",description:"Please enter who drove the vehicle",variant:"destructive"});if(Z.isClientTestDrive&&!(null==(e=Z.clientName)?void 0:e.trim()))return void x({title:"Client Name Required",description:"Please enter the client's name for client test drives",variant:"destructive"});const t=new Date,s=Math.round((t.getTime()-q.startTime.getTime())/1e3/60);l(e=>e.filter(e=>e.id!==q.id)),J(!1),z(null);const a=c(n({},q),{endTime:t,duration:s,driverName:Z.driverName,clientName:Z.clientName,isClientTestDrive:Z.isClientTestDrive,testDriveNotes:Z.testDriveNotes,completedAt:(new Date).toISOString()}),r=JSON.parse(localStorage.getItem("testDriveHistory")||"[]");r.push(a),localStorage.setItem("testDriveHistory",JSON.stringify(r));try{const e={car_vin:q.vin,car_model:q.carModel,client_name:Z.clientName||Z.driverName,client_phone:"",client_email:"",issue_description:`${Z.isClientTestDrive?"Client":"Employee"} Test Drive - Scanned by: ${q.employeeScanned}. ${Z.testDriveNotes||"Standard test drive evaluation"}`,solution_description:`Test drive completed successfully. Duration: ${s} minutes. Scanned by: ${q.employeeScanned}, Driver: ${Z.driverName}${Z.clientName?`, Client: ${Z.clientName}`:""}. ${Z.testDriveNotes?`Notes: ${Z.testDriveNotes}`:""}`,repair_steps:["Employee scanned VIN and took vehicle instantly","Test drive commenced immediately with timer tracking","Vehicle performance evaluated during drive","Test drive completed and returned safely","Client/driver details collected and recorded"],parts_used:[],labor_hours:s/60,total_cost:0,technician_name:q.employeeScanned,repair_date:q.startTime.toISOString().split("T")[0],completion_date:t.toISOString().split("T")[0],photos:[],before_photos:[],after_photos:[],repair_category:"Test Drive",difficulty_level:"easy",quality_rating:5,client_satisfaction:5,warranty_period:0,follow_up_required:Z.isClientTestDrive,follow_up_notes:Z.isClientTestDrive?"Follow up with client for sales opportunity":void 0};yield O.saveRepairHistory(e)}catch(i){x({title:"Partial Save",description:"Test drive completed but may not be fully recorded in history",variant:"destructive",duration:3e3})}}),className:"bg-green-600 hover:bg-green-700 text-white px-8 py-3 text-base font-bold",children:[h.jsx(k,{className:"h-5 w-5 mr-2"}),"COMPLETE TEST DRIVE"]})]})]})]})})]})};export{U as default};
